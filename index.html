<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prebeg Christmas Chaos: Family Edition</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Custom Styles -->
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #0f172a; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Custom Scrollbar for Hand */
        .custom-scrollbar::-webkit-scrollbar { height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        /* Snow Animation */
        .snowflake {
            position: fixed;
            top: -10px;
            color: white;
            opacity: 0.8;
            pointer-events: none;
            z-index: 5;
            animation: fall linear infinite;
        }
        @keyframes fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.8; }
            100% { transform: translateY(110vh) rotate(360deg); opacity: 0; }
        }

        /* Card Reveal Animations */
        @keyframes popIn {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            80% { transform: scale(1.1) rotate(5deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        @keyframes dropToHand {
            0% { transform: scale(1) translateY(0); opacity: 1; }
            100% { transform: scale(0.2) translateY(500px); opacity: 0; }
        }

        .animate-pop-in { animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .animate-drop-to-hand { animation: dropToHand 0.8s ease-in forwards; }

        /* THEMATIC BOARD: UGLY SWEATER / BEER PONG TABLE */
        .table-cloth {
            background-color: #1a1a1a; 
            background-image: 
                radial-gradient(#333 15%, transparent 16%),
                radial-gradient(#333 15%, transparent 16%);
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
            border: 12px solid #3f2e2e; /* Dark Wood border */
            border-radius: 24px;
            box-shadow: 
                inset 0 0 80px rgba(0,0,0,0.9),
                0 20px 50px rgba(0,0,0,0.8);
            position: relative;
        }
        
        /* Beer Rings / Stains */
        .beer-ring {
            position: absolute;
            border: 6px solid rgba(255, 255, 255, 0.05);
            border-radius: 50%;
            pointer-events: none;
            filter: blur(1px);
        }

        /* Ornament Styling */
        .plate {
            background: radial-gradient(circle at 30% 30%, #475569, #1e293b);
            border-radius: 50%;
            box-shadow: 0 8px 10px -4px rgba(0,0,0,0.6), inset 0 2px 4px rgba(255,255,255,0.1);
            border: 2px solid #64748b;
            position: relative;
            transition: transform 0.2s;
        }
        .plate.start-tile { background: radial-gradient(circle at 30% 30%, #16a34a, #14532d); border-color: #22c55e; }
        .plate.end-tile { background: radial-gradient(circle at 30% 30%, #eab308, #854d0e); border-color: #facc15; }
        
        /* Floating Text Animation */
        @keyframes floatUpFade {
            0% { transform: translate(-50%, 0) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -60px) scale(1.5); opacity: 0; }
        }
        .float-text {
            position: absolute;
            left: 50%;
            top: -30px;
            transform: translateX(-50%);
            font-weight: 900;
            text-shadow: 2px 2px 0px #000, 0 0 10px rgba(0,0,0,0.5);
            color: #fbbf24;
            pointer-events: none;
            animation: floatUpFade 2s ease-out forwards;
            z-index: 100;
            white-space: nowrap;
            font-size: 1.5rem;
        }

        /* LED / Jumbotron Styles */
        .led-text {
            font-family: 'Courier New', Courier, monospace;
            text-shadow: 0 0 5px currentColor;
        }
        .scanline {
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px;
        }
        
        /* Animations */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up { animation: fadeInUp 0.3s ease-out forwards; }
        .text-shadow-glow { text-shadow: 0 0 10px currentColor; }
        
        /* Dice Animation */
        @keyframes shake {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(15deg); }
            50% { transform: rotate(0deg); }
            75% { transform: rotate(-15deg); }
            100% { transform: rotate(0deg); }
        }
        .dice-shake { animation: shake 0.1s infinite; }

        /* TV Static Animation */
        @keyframes static-noise {
            0% { background-position: 0 0; }
            100% { background-position: 100% 100%; }
        }
        
    </style>
</head>
<body class="bg-slate-950 min-h-screen text-gray-200 overflow-x-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- AUDIO ENGINE (Web Audio API) ---
        const SoundEngine = {
            ctx: null,
            muted: false,
            init: () => {
                if (!SoundEngine.ctx) {
                    SoundEngine.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (SoundEngine.ctx.state === 'suspended') {
                    SoundEngine.ctx.resume();
                }
            },
            toggleMute: () => {
                SoundEngine.muted = !SoundEngine.muted;
                return SoundEngine.muted;
            },
            play: (type) => {
                if (SoundEngine.muted) return;
                SoundEngine.init();
                const ctx = SoundEngine.ctx;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                const now = ctx.currentTime;

                switch (type) {
                    case 'click': osc.type = 'sine'; osc.frequency.setValueAtTime(800, now); gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1); osc.start(now); osc.stop(now + 0.1); break;
                    case 'step': osc.type = 'triangle'; osc.frequency.setValueAtTime(120, now); gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1); osc.start(now); osc.stop(now + 0.1); break;
                    case 'roll': osc.type = 'square'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(600, now + 0.1); gain.gain.setValueAtTime(0.02, now); gain.gain.linearRampToValueAtTime(0, now + 0.1); osc.start(now); osc.stop(now + 0.1); break;
                    case 'success': osc.type = 'sine'; [523.25, 659.25].forEach((f,i) => { const o = ctx.createOscillator(); const g = ctx.createGain(); o.connect(g); g.connect(ctx.destination); o.frequency.value = f; g.gain.setValueAtTime(0.03, now + i*0.1); g.gain.exponentialRampToValueAtTime(0.001, now + i*0.1 + 0.4); o.start(now + i*0.1); o.stop(now + i*0.1 + 0.4); }); break;
                    case 'fail': osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(40, now + 0.3); gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now + 0.3); osc.start(now); osc.stop(now + 0.3); break;
                    case 'win': osc.type = 'triangle'; [523.25, 659.25, 783.99, 1046.50, 1318.51].forEach((f,i) => { const o = ctx.createOscillator(); const g = ctx.createGain(); o.connect(g); g.connect(ctx.destination); o.frequency.value = f; g.gain.setValueAtTime(0.03, now + i*0.1); g.gain.exponentialRampToValueAtTime(0.001, now + i*0.1 + 0.6); o.start(now + i*0.1); o.stop(now + i*0.1 + 0.6); }); break;
                    case 'alert': osc.type = 'square'; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(600, now + 0.15); gain.gain.setValueAtTime(0.03, now); gain.gain.linearRampToValueAtTime(0, now + 0.15); osc.start(now); osc.stop(now + 0.15); break;
                    case 'shield': osc.type = 'sine'; osc.frequency.setValueAtTime(200, now); osc.frequency.linearRampToValueAtTime(800, now + 0.3); gain.gain.setValueAtTime(0.03, now); gain.gain.linearRampToValueAtTime(0, now + 0.3); osc.start(now); osc.stop(now + 0.3); break;
                    case 'channel': osc.type = 'sawtooth'; osc.frequency.setValueAtTime(50, now); gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now + 0.05); osc.start(now); osc.stop(now + 0.05); break;
                }
            }
        };

        // --- ICONS (SVG) ---
        const Icon = ({ path, className = "w-6 h-6", ...props }) => (<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d={path} /></svg>);

        // Icons
        const Gift = (props) => <Icon path="M20 12v10H4V12M2 7h20v5H2zm10 5v10M12 7V3m0 4h3a3 3 0 0 0 0-6h-3m0 6H9a3 3 0 0 1 0-6h3" {...props} />;
        const Beer = (props) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M17 11h1a3 3 0 0 1 0 6h-1"/><path d="M9 12v6"/><path d="M13 12v6"/><path d="M14 7.5c-1.7 0-3 1.3-3 3h5c0-1.7-1.3-3-3-3z"/><path d="M10 7.5c-1.7 0-3 1.3-3 3h5c0-1.7-1.3-3-3-3z"/><path d="M6 7.5c-1.7 0-3 1.3-3 3h5c0-1.7-1.3-3-3-3z"/><path d="M5 10.5v10.5a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-10.5"/></svg>;
        const Skull = (props) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><path d="M8 20v2h8v-2"/><path d="M12.5 17l-.5-1-.5 1h1z"/><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20"/></svg>;
        const Devil = (props) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 4c-3.3 0-6 2.7-6 6v4c0 3.3 2.7 6 6 6s6-2.7 6-6v-4c0-3.3-2.7-6-6-6z"/><path d="M17 4l-1.5 3"/><path d="M7 4l1.5 3"/><path d="M9 14s1.5 1 3 1 3-1 3-1"/></svg>;
        const Shield = (props) => <Icon path="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" {...props} />;
        const ArrowRight = (props) => <Icon path="M5 12h14M12 5l7 7-7 7" {...props} />;
        const Edit2 = (props) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>;
        const BookOpen = (props) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>;
        const X = (props) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>;
        const Swords = (props) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"/><line x1="13" y1="19" x2="19" y2="13"/><line x1="16" y1="16" x2="20" y2="20"/><line x1="19" y1="21" x2="21" y2="19"/><polyline points="14.5 6.5 18 3 21 3 21 6 17.5 9.5"/><line x1="5" y1="14" x2="9" y2="18"/><line x1="7" y1="17" x2="4" y2="20"/><line x1="3" y1="19" x2="5" y2="21"/></svg>;
        const Volume2 = (props) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>;
        const VolumeX = (props) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg>;
        const Save = (props) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>;
        const Upload = (props) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>;
        const RotateCcw = (props) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 2v6h6"/><path d="M3 13a9 9 0 1 0 3-7.7L3 8"/></svg>;
        const RefreshCw = (props) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>;
        const Utensils = (props) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></svg>;
        const Dna = (props) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M2 15c6.667-6 13.333 0 20-6"/><path d="M9 22c1.798-1.998 2.518-3.995 2.807-5.993"/><path d="M15 2c-1.798 1.998-2.518 3.995-2.807 5.993"/><path d="M17 12a5.002 5.002 0 0 0-3 7"/><path d="M12 12a5.002 5.002 0 0 0 4-3"/></svg>;
        const HelpCircle = (props) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>;
        const Power = (props) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><line x1="12" y1="2" x2="12" y2="12"/></svg>;
        const TvRemote = (props) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="6" y="2" width="12" height="20" rx="2"/><circle cx="12" cy="6" r="1"/><path d="M9 10h6"/><path d="M9 14h6"/><path d="M12 18h.01"/></svg>;
        const Settings = (props) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>;

        // --- GAME DATA & CONSTANTS ---
        const BOARD_SIZE = 29; 
        const GRID_COLS = 5; 
        const GRID_ROWS = 6;

        const COLORS = [
          { name: 'Red', bg: 'bg-red-600', text: 'text-red-500', border: 'border-red-800', ring: 'ring-red-400', icon: 'üç∫' },
          { name: 'Green', bg: 'bg-green-600', text: 'text-green-500', border: 'border-green-800', ring: 'ring-green-400', icon: 'üç∑' },
          { name: 'Blue', bg: 'bg-blue-600', text: 'text-blue-500', border: 'border-blue-800', ring: 'ring-blue-400', icon: 'üç∏' },
          { name: 'Yellow', bg: 'bg-yellow-500', text: 'text-yellow-600', border: 'border-yellow-700', ring: 'ring-yellow-300', icon: 'üçπ' },
          { name: 'Purple', bg: 'bg-purple-600', text: 'text-purple-600', border: 'border-purple-800', ring: 'ring-purple-400', icon: 'ü•É' },
          { name: 'Pink', bg: 'bg-pink-500', text: 'text-pink-600', border: 'border-pink-700', ring: 'ring-pink-300', icon: 'üçæ' },
          { name: 'Cyan', bg: 'bg-cyan-500', text: 'text-cyan-600', border: 'border-cyan-700', ring: 'ring-cyan-300', icon: 'üç∂' },
          { name: 'Orange', bg: 'bg-orange-600', text: 'text-orange-600', border: 'border-orange-800', ring: 'ring-orange-400', icon: 'ü•§' },
        ];

        const ROLES = {
          DRUNK: { id: 'drunk', name: 'The Drunk', desc: 'Starts with "Uncle Mike\'s Flask".', icon: 'üç∫' },
          MOOCH: { id: 'mooch', name: 'The Mooch', desc: 'Immune to "Pay Up" (Steals).', icon: 'ü§ë' },
          KAREN: { id: 'karen', name: 'The Karen', desc: 'Calls manager if others cheat.', icon: 'üë±‚Äç‚ôÄÔ∏è' },
          PRUDE: { id: 'prude', name: 'The Prude', desc: 'Starts with "Aunt Sheila\'s Bible".', icon: '‚úùÔ∏è' },
          CHEF: { id: 'chef', name: 'The Cook', desc: 'Immune to "Mom\'s Burnt Turkey".', icon: 'üë®‚Äçüç≥' },
          STONER: { id: 'stoner', name: 'The Stoner', desc: 'Immune to "Cousin Kyle\'s Munchies".', icon: 'ü•¨' },
          GRINCH: { id: 'grinch', name: 'The Asshole', desc: 'Attacks push back extra spaces.', icon: 'üñï' },
          DOG: { id: 'dog', name: 'The Dog', desc: 'Literally the family dog. Shielded.', icon: 'üêï' },
          DAD: { id: 'dad', name: 'The Dad', desc: 'Starts with "The Belt" (Push back).', icon: 'üëî' },
          MOM: { id: 'mom', name: 'The Mom', desc: 'Starts with "Guilt Trip" (Move fwd).', icon: 'üç∑' },
        };

        const SPECIAL_TILES = {
          3: { icon: 'ü§Æ', label: 'Dog Puked', desc: 'Sparky puked on your shoes. Go back 1.' },
          7: { icon: 'ü•É', label: 'Grandpa\'s Scotch', desc: 'Aged 20 years. Nothing happens.' },
          12: { icon: 'üí§', label: 'Uncle Jim', desc: 'Tripped over sleeping Uncle Jim. Skip turn.' },
          18: { icon: 'ü§¨', label: 'Aunt Karen', desc: 'Argument about politics! Skip turn.' },
          24: { icon: 'üíä', label: 'Cousin Nick', desc: 'Nick gave you a "vitamin". Double roll.' },
          28: { icon: 'üöΩ', label: 'The Can', desc: 'Almost there!' },
        };

        const OFFENSIVE_DECK = [
          { id: 'o_johnny', title: 'Cole\'s Coal', desc: 'Cole reported you to Santa.', effect: 'move_back', value: 3, flavor: 'You were bad. Back 3.' },
          { id: 'o_sam', title: 'Guy\'s Grinch Attack', desc: 'Guy stole Christmas (and your turn).', effect: 'global_skip', value: 1, flavor: 'Everyone skips! Guy is mean.' },
          { id: 'o_trevor', title: 'Trevor\'s Fake Snow', desc: 'Trevor threw packing peanuts everywhere.', effect: 'skip_turn', value: 1, flavor: 'Cleaning up mess. Skip turn.' },
          { id: 'o_kyle', title: 'Kyle\'s Icy Patch', desc: 'Kyle "forgot" to salt the driveway.', effect: 'skip_turn', value: 1, flavor: 'Slipped and fell. Skip turn.' },
          { id: 'o_jeremy', title: 'Jeremy\'s Ugly Sweater', desc: 'Jeremy forced you to wear it.', effect: 'move_back', value: 2, flavor: 'Fashion crime! Back 2.' },
          { id: 'o_johnny_2', title: 'Johnny\'s Prank', desc: 'Johnny tied your laces.', effect: 'move_back', value: 2, flavor: 'Tripped! Back 2.' },
          { id: 'o_sam_2', title: 'Sam\'s Tantrum', desc: 'Sam screamed at the turkey.', effect: 'skip_turn_2', value: 2, flavor: 'Ear ache. Skip 2 turns.' },
          { id: 'o_trevor_2', title: 'Trevor\'s "Special" Drink', desc: 'Trevor spiked the eggnog.', effect: 'swap_last', value: 0, flavor: 'Passed out. Swap with loser.' },
          { id: 'o_kyle_2', title: 'Kyle\'s Bad Parking', desc: 'Blocked everyone in.', effect: 'global_skip', value: 1, flavor: 'No one leaves! All Skip.' },
          { id: 'o_jeremy_2', title: 'Jeremy\'s Playlist', desc: 'Jeremy played polka for 3 hours.', effect: 'discard_hand', value: 0, flavor: 'Ears bleeding. Lose hand.' },
          { id: 'o_badgift', title: 'Regifted Dildo', desc: 'Grandma opened the wrong box.', effect: 'move_back', value: 3, flavor: 'Awkward silence. Back 3.' },
          { id: 'o_pissed', title: 'Titan\'s Revenge', desc: 'Titan pissed on your sleeping bag.', effect: 'discard_hand', value: 0, flavor: 'Soaked. Discard hand.' },
          // New Offensive Cards
          { id: 'o_zack_guy', title: 'Front Lawn Brawl', desc: 'Zack & Guy fighting in snow!', effect: 'global_skip', value: 1, flavor: 'Global Stun! Everyone watches.' },
          { id: 'o_papa_lib', title: 'Bathroom Library', desc: 'Papa has a magazine.', effect: 'skip_turn_2', value: 2, flavor: 'Dad has to shit before everything. Skip 2 turns.' },
          { id: 'o_marty_krampus', title: 'Krampus Arrives', desc: 'Marty tells an unrelated story.', effect: 'swap_last', value: 0, flavor: 'Swap with last place!' },
          { id: 'o_theresa_pinch', title: 'Cheek Pincher', desc: 'Aunt Theresa got you.', effect: 'skip_turn', value: 1, flavor: 'Immobilized by love. Skip turn.' },
          { id: 'o_trevor_saran', title: 'Saran Wrap Trap', desc: 'Trevor strikes with another prank, Shit is all over the bathroom.', effect: 'move_back', value: 3, flavor: 'Clean up! Back 3 spaces.' },
          { id: 'o_trevor_bucket', title: 'Bucket of Water', desc: 'Balanced on the door.', effect: 'discard_hand', value: 0, flavor: 'Soaked! Discard hand.' },
          { id: 'o_ian_lights', title: 'Tangled Lights', desc: 'Ian lied about packing.', effect: 'skip_turn', value: 1, flavor: 'Untangle them! Skip turn.' },
          { id: 'o_dylan_cookies', title: 'Burnt Cookies', desc: 'Dylan tried to help bake.', effect: 'move_back', value: 3, flavor: 'Fire Dept coming! Back 3.' },
          { id: 'o_roger_gift', title: 'Re-Packed Gift', desc: 'Uncle Rogers closet found gift.', effect: 'move_back', value: 2, flavor: 'Heavy! Back 2 spaces.' },
          { id: 'o_copper_emily', title: 'Knocked Over Tree', desc: 'Copper and Emily tail wagging disaster.', effect: 'move_back', value: 4, flavor: 'Timber! Back 4 spaces.' },
          { id: 'o_kyle_tongue', title: 'Frozen Tongue', desc: 'Kyle licked the pole.', effect: 'swap', value: 0, flavor: 'Stuck! Swap places.' },
          { id: 'o_ian_shop', title: 'Last Minute Shop', desc: 'Ian forgot Mom.', effect: 'skip_turn', value: 1, flavor: 'Drive him to mall. Skip turn.' },
        ];

        const DEFENSIVE_DECK = [
          { id: 'd_chance', title: 'Chance\'s Elf Magic', desc: 'Chance fixed the broken lights.', effect: 'shield', value: 1, flavor: 'Saved the day! Shield up.' },
          { id: 'd_austin', title: 'Austin\'s Reindeer', desc: 'Austin flew you to the roof.', effect: 'move_forward', value: 5, flavor: 'Flying high! +5 spaces.' },
          { id: 'd_zane', title: 'Zane\'s Tech Gift', desc: 'Zane hacked the game for you.', effect: 'move_forward', value: 3, flavor: 'Cheat code activated. +3.' },
          { id: 'd_max', title: 'Max\'s Spirit', desc: 'Max reminded everyone of love.', effect: 'shield', value: 1, flavor: 'Aww. You are protected.' },
          { id: 'd_papa', title: 'Papa\'s Workshop', desc: 'Papa built you a shortcut.', effect: 'draw_card', value: 1, flavor: 'Handy! Draw a card.' },
          { id: 'd_lala', title: 'Lala\'s Cookies', desc: 'Lala made fresh cookies.', effect: 'move_forward', value: 4, flavor: 'Sugar rush! +4 spaces.' },
          { id: 'd_chance_2', title: 'Chance\'s Song', desc: 'Chance sang a carol.', effect: 'move_forward', value: 2, flavor: 'Soaring spirits. +2.' },
          { id: 'd_austin_2', title: 'Austin\'s Sleigh', desc: 'Austin gave you a lift.', effect: 'goto_leader', value: 0, flavor: 'Uber Sleigh to the leader!' },
          { id: 'd_zane_2', title: 'Zane\'s App', desc: 'Zane made an app to win.', effect: 'double_roll', value: 0, flavor: 'Double roll next turn.' },
          { id: 'd_max_2', title: 'Max\'s Hug', desc: 'Max gave a great hug.', effect: 'shield', value: 1, flavor: 'Warm fuzzy feelings.' },
          { id: 'd_papa_2', title: 'Papa\'s Tools', desc: 'Papa fixed your flat tire.', effect: 'move_forward', value: 3, flavor: 'Back on road. +3.' },
          { id: 'd_lala_2', title: 'Lala\'s Feast', desc: 'Lala cooked a feast.', effect: 'draw_card', value: 1, flavor: 'Full belly. Draw card.' },
          // New Defensive Cards
          { id: 'd_rosie_flask', title: 'Flask in the Boot', desc: 'Aunt Rosie slipped you her flask.', effect: 'shield', value: 1, flavor: 'Numb the pain. Immune to next bullshit card.' },
          { id: 'd_guy_coffee', title: 'Irish Coffee', desc: 'Grandma spiked it.', effect: 'move_forward', value: 4, flavor: 'You have the energy of a meth squirrel. Forward 4.' },
          { id: 'd_anna_gaslight', title: 'Gaslighting', desc: 'Chance convinced everyone it wasn\'t you.', effect: 'move_forward', value: 3, flavor: 'You convinced Mom she forgot the oven. Crisis averted. +3.' },
          { id: 'd_max_driver', title: 'Designated Driver', desc: 'Max is the only sober one.', effect: 'shield', value: 1, flavor: 'You hold the keys. You are safe.' },
          { id: 'd_ava_fav', title: 'The Favorite Child', desc: 'Mom loves Ava best.', effect: 'goto_leader', value: 0, flavor: 'Mom loves you best. Warp to the leader.' },
          { id: 'd_lala_stash', title: 'Secret Stash', desc: 'Lala hid the good wine.', effect: 'move_forward', value: 3, flavor: 'Hide in the pantry and chug. +3 spaces.' },
          { id: 'd_papa_nap', title: 'Strategic Nap', desc: 'Papa fell asleep on the couch.', effect: 'move_forward', value: 2, flavor: 'Avoided the argument. Well rested. +2.' },
          { id: 'd_zane_med', title: 'Medical Support', desc: 'Zane fixed the broken whatever.', effect: 'move_forward', value: 3, flavor: 'Now we can ignore each other on our phones. +3.' },
          { id: 'd_meagan_shield', title: 'Kids Table Shield', desc: 'Meagan saved you a seat.', effect: 'shield', value: 1, flavor: 'They are sticky but safe. Immune.' },
          { id: 'd_max_saint', title: 'Saint Maxwell', desc: 'Max took everything for himself.', effect: 'global_reset_hands', value: 0, flavor: 'Max reminds everyone what Christmas is really about.' },
        ];

        const DRUNK_CARD = { id: 'special_beer', title: 'Uncle Mike\'s Flask', desc: 'Secret whiskey makes it better.', effect: 'shield', value: 1, flavor: 'Numb the pain.' };
        const DAD_BELT_CARD = { id: 'special_belt', title: 'The Belt', desc: 'Listen to your father!', effect: 'move_back', value: 2, flavor: 'Fear tactic. Push back 2.' };
        const MOM_GUILT_CARD = { id: 'special_guilt', title: 'Mom\'s Guilt Trip', desc: 'Why don\'t you call more?', effect: 'move_forward', value: 3, flavor: 'Emotional damage. Move 3.' };

        const GAME_PHASES = {
          SETUP_COUNT: 'SETUP_COUNT',
          SETUP_NAMES: 'SETUP_NAMES',
          START_TURN: 'START_TURN',
          ROLLING: 'ROLLING',
          MOVING: 'MOVING',
          BATTLE: 'BATTLE', 
          EVENT_TRIGGER: 'EVENT_TRIGGER', 
          DRAW_CHOICE: 'DRAW_CHOICE',
          CARD_REVEAL: 'CARD_REVEAL', 
          TURN_TRANSITION: 'TURN_TRANSITION',
          GAME_OVER: 'GAME_OVER',
        };

        const Snow = () => {
            const snowflakes = useMemo(() => Array.from({ length: 30 }).map((_, i) => ({
                id: i, left: Math.random() * 100, delay: Math.random() * 5, size: Math.random() * 0.5 + 0.5
            })), []);
            return <div className="fixed inset-0 pointer-events-none z-0">{snowflakes.map(s => <div key={s.id} className="snowflake text-white" style={{ left: `${s.left}%`, animationDelay: `${s.delay}s`, fontSize: `${s.size}rem` }}>‚ùÑ</div>)}</div>;
        };

        const MiniTV = () => {
            const [isOn, setIsOn] = useState(true);
            const [channelIndex, setChannelIndex] = useState(0);
            const PLAYLIST_ID = "PLk0wv9A07kR1EfAtNTHlycxbdsX9FZ1Tv";

            const changeChannel = () => {
                SoundEngine.play('channel');
                setChannelIndex((prev) => (prev + 1) % 30); // Cycle through 30 videos
            };
            
            return (
                <div className="fixed bottom-4 right-4 z-50 flex flex-col items-end">
                    <div className={`relative bg-yellow-900 p-2 rounded-xl border-4 border-yellow-950 shadow-2xl transition-all duration-500 ${isOn ? 'w-64 md:w-80' : 'w-64 md:w-80 opacity-50'}`}>
                        {/* Antenna */}
                        <div className="absolute -top-12 left-1/2 -translate-x-1/2 w-24 h-12 pointer-events-none">
                            <div className="absolute bottom-0 left-0 w-1 h-16 bg-gray-400 origin-bottom -rotate-[30deg]"></div>
                            <div className="absolute bottom-0 right-0 w-1 h-16 bg-gray-400 origin-bottom rotate-[30deg]"></div>
                        </div>
                        
                        {/* Screen */}
                        <div className="relative aspect-video bg-black rounded-lg overflow-hidden border-4 border-gray-800 shadow-inner">
                            {isOn ? (
                                <iframe 
                                    className="w-full h-full pointer-events-none"
                                    src={`https://www.youtube.com/embed?listType=playlist&list=${PLAYLIST_ID}&index=${channelIndex}&autoplay=1&mute=1&controls=0&showinfo=0&modestbranding=1`}
                                    title="Christmas Movies" 
                                    frameBorder="0" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowFullScreen
                                ></iframe>
                            ) : (
                                <div className="w-full h-full bg-gray-900 flex items-center justify-center">
                                    <div className="w-1 h-1 bg-white rounded-full animate-ping"></div>
                                </div>
                            )}
                            
                            {/* CRT Glare */}
                            <div className="absolute inset-0 bg-gradient-to-tr from-transparent via-white/5 to-transparent pointer-events-none"></div>
                            <div className="absolute inset-0 scanline pointer-events-none opacity-20"></div>
                            
                            {/* Channel Indicator (Briefly visible on switch) */}
                            {isOn && (
                                <div key={channelIndex} className="absolute top-2 right-2 text-green-500 font-mono text-xl opacity-80 pointer-events-none animate-pop-in">
                                    CH {channelIndex + 1}
                                </div>
                            )}
                        </div>

                        {/* Controls */}
                        <div className="flex justify-between items-center mt-2 px-2">
                            <div className="flex gap-1">
                                <div className="w-2 h-2 bg-gray-800 rounded-full"></div>
                                <div className="w-2 h-2 bg-gray-800 rounded-full"></div>
                                <div className="w-2 h-2 bg-gray-800 rounded-full"></div>
                            </div>
                            
                            <div className="flex gap-2">
                                {/* Channel Knob */}
                                <button 
                                    onClick={changeChannel}
                                    disabled={!isOn}
                                    className={`w-8 h-8 rounded-full border-2 bg-gray-800 border-gray-600 flex items-center justify-center text-gray-400 hover:text-white hover:border-gray-400 transition-all active:rotate-45 ${!isOn ? 'opacity-50 cursor-not-allowed' : ''}`}
                                    title="Change Channel"
                                >
                                    <span className="text-[10px] font-bold">CH</span>
                                </button>

                                {/* Power Button */}
                                <button 
                                    onClick={() => { SoundEngine.play('click'); setIsOn(!isOn); }} 
                                    className={`p-1 rounded-full border-2 transition-colors ${isOn ? 'bg-green-500 border-green-700 text-green-900' : 'bg-red-500 border-red-700 text-red-900'} hover:scale-110`}
                                    title="Toggle Power"
                                >
                                    <Power className="w-4 h-4" />
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Confetti = () => {
          const [particles, setParticles] = useState([]);
          useEffect(() => {
            const colors = ['#f0f', '#0ff', '#ff0', '#f00']; 
            const count = 100;
            const newParticles = Array.from({ length: count }).map((_, i) => ({
              id: i, x: Math.random() * 100, color: colors[Math.floor(Math.random() * colors.length)], delay: Math.random() * 2, duration: 3 + Math.random() * 2,
            }));
            setParticles(newParticles);
          }, []);
          return (
            <div className="fixed inset-0 pointer-events-none z-[60] overflow-hidden">
              {particles.map(p => (<div key={p.id} className="absolute w-3 h-3 rounded-full" style={{ left: `${p.x}%`, top: `-20px`, backgroundColor: p.color, animation: `fall ${p.duration}s linear ${p.delay}s infinite` }} />))}
            </div>
          );
        };

        const Card = ({ card, onClick, isSelected, isRevealed }) => {
            const isMax = card.id.toLowerCase().includes('max');
            
            return (
              <div onClick={onClick} className={`relative w-36 h-60 rounded-xl shadow-lg p-2 flex flex-col justify-between cursor-pointer transition-all transform duration-200 shrink-0 ${isRevealed ? 'w-80 h-auto min-h-[28rem] z-50 animate-pop-in' : ''} ${isSelected ? 'ring-4 ring-yellow-400 scale-105 z-10 -translate-y-4' : 'hover:scale-105 hover:-translate-y-2'} ${card.id === 'd_klepto' ? 'bg-gradient-to-br from-purple-700 to-purple-900 border-4 border-yellow-400' : card.id.startsWith('o_') || card.id === 'special_belt' ? 'bg-gradient-to-br from-red-100 to-red-200 border-2 border-red-800' : 'bg-gradient-to-br from-blue-100 to-blue-200 border-2 border-blue-800'}`}>
                <div className="absolute inset-0 opacity-10" style={{ backgroundImage: 'radial-gradient(circle, #000 1px, transparent 1px)', backgroundSize: '10px 10px' }}></div>
                <div className={`relative z-10 text-[10px] font-black text-center uppercase tracking-widest mb-1 border-b-2 pb-1 ${isRevealed ? 'text-base border-b-4 pb-2 mb-2' : ''} ${card.id === 'd_klepto' ? 'text-yellow-400 border-yellow-400' : card.id.startsWith('o_') || card.id === 'special_belt' ? 'border-red-800 text-red-900' : 'border-blue-800 text-blue-900'}`}>
                    {card.id === 'd_klepto' ? 'üñï DIRTY' : card.id.startsWith('o_') || card.id === 'special_belt' ? '‚ò†Ô∏è OFFENSIVE' : 'üõ°Ô∏è DEFENSIVE'}
                </div>
                <div className={`relative z-10 w-full flex-1 flex flex-col items-center justify-center text-center p-2 border border-black/10 rounded bg-white/40 backdrop-blur-sm my-2 shadow-inner overflow-hidden`}>
                     <div className={`${isRevealed ? 'mb-4' : 'mb-2'} filter drop-shadow-md transform transition-transform hover:scale-110 duration-300 flex justify-center items-center`}>
                        {isMax ? (
                            <img src="https://i.postimg.cc/6Qb7G25v/Gemini_Generated_Image_c2dfeyc2dfeyc2df.png" alt="Max" className={`${isRevealed ? 'w-32 h-32' : 'w-16 h-16'} object-contain rounded-lg shadow-sm`} />
                        ) : (
                            <span className={`${isRevealed ? 'text-6xl' : 'text-4xl'}`}>
                                {card.id.startsWith('o_') ? 'üî™' : card.effect === 'shield' ? 'üõ°Ô∏è' : card.effect.includes('skip') ? 'üö´' : 'üéÅ'}
                            </span>
                        )}
                     </div>
                     <div className={`${isRevealed ? 'text-3xl' : 'text-sm'} font-black uppercase leading-tight ${card.id === 'd_klepto' ? 'text-white' : 'text-gray-900'}`}>{card.title}</div>
                </div>
                <div className={`relative z-10 ${isRevealed ? 'text-lg my-2' : 'text-[10px] line-clamp-3'} ${card.id === 'd_klepto' ? 'text-purple-200' : 'text-gray-800'} text-center font-bold leading-tight px-1`}>{card.desc}</div>
                <div className={`relative z-10 mt-auto ${isRevealed ? 'text-xs p-3' : 'text-[9px] p-1'} font-bold text-center rounded shadow-sm italic ${card.id === 'd_klepto' ? 'bg-yellow-400 text-purple-900' : card.id.startsWith('o_') || card.id === 'special_belt' ? 'bg-red-900/10 text-red-900' : 'bg-blue-900/10 text-blue-900'}`}>"{card.flavor}"</div>
              </div>
            );
        };

        const PlayerToken = ({ player, isActive, floatText }) => (
          <div className={`w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center text-lg md:text-2xl shadow-lg border-2 relative transition-all duration-300 z-10 bg-white ${player.color.border} ${isActive ? 'ring-4 ring-white ring-offset-2 ring-offset-amber-200 scale-125 z-20 animate-bounce' : ''}`} title={`${player.name} (${player.role.name})`}>
            {player.icon}
            {player.shield && (<div className="absolute -top-3 -right-3 bg-blue-600 text-white rounded-full p-0.5 w-5 h-5 flex items-center justify-center text-[10px] shadow border border-white">üõ°Ô∏è</div>)}
            {floatText && <div className={`float-text`}>{floatText}</div>}
          </div>
        );

        // --- ADMIN PANEL COMPONENT ---
        const AdminPanel = ({ isOpen, onClose, offensiveDeck, setOffensiveDeck, defensiveDeck, setDefensiveDeck, onReset, gameConfig, setGameConfig }) => {
            if (!isOpen) return null;
            const [activeTab, setActiveTab] = useState('general'); // Default to general now
            const [editingId, setEditingId] = useState(null);

            const currentDeck = activeTab === 'offensive' ? offensiveDeck : activeTab === 'defensive' ? defensiveDeck : [];
            const setDeck = activeTab === 'offensive' ? setOffensiveDeck : activeTab === 'defensive' ? setDefensiveDeck : null;

            const handleUpdate = (id, field, value) => {
                if (!setDeck) return;
                const newDeck = currentDeck.map(card => card.id === id ? { ...card, [field]: value } : card);
                setDeck(newDeck);
            };

            const handleConfigChange = (field, value) => {
                setGameConfig(prev => ({ ...prev, [field]: value }));
            };

            return (
                <div className="fixed inset-0 bg-slate-950/95 backdrop-blur-lg z-[100] flex flex-col items-center justify-start p-6 overflow-hidden animate-in fade-in zoom-in duration-300">
                    <div className="w-full max-w-5xl h-full flex flex-col bg-gray-900 rounded-3xl border border-gray-800 shadow-2xl relative overflow-hidden">
                        
                        {/* Header */}
                        <div className="bg-gray-950 p-6 border-b border-gray-800 flex justify-between items-center shrink-0">
                            <div>
                                <h2 className="text-3xl font-black text-white uppercase tracking-wider flex items-center gap-3">
                                    <Settings className="w-8 h-8 text-gray-400" /> Admin Panel
                                </h2>
                                <p className="text-gray-500 text-sm">Customize card text to match your family trauma.</p>
                            </div>
                            <div className="flex gap-4">
                                <button onClick={() => { if(confirm("Reset all cards to default?")) onReset(); }} className="px-4 py-2 rounded-lg bg-red-900/30 text-red-400 border border-red-900 hover:bg-red-900/50 text-xs font-bold uppercase tracking-widest transition-colors">Reset Defaults</button>
                                <button onClick={onClose} className="p-2 bg-gray-800 rounded-full hover:bg-gray-700 transition-colors"><X className="w-6 h-6 text-gray-400" /></button>
                            </div>
                        </div>

                        {/* Tabs */}
                        <div className="flex border-b border-gray-800 shrink-0">
                            <button onClick={() => setActiveTab('general')} className={`flex-1 py-4 text-center font-black uppercase tracking-widest transition-colors ${activeTab === 'general' ? 'bg-gray-800 text-white border-b-2 border-white' : 'text-gray-500 hover:text-gray-300 hover:bg-gray-800'}`}>General Settings</button>
                            <button onClick={() => setActiveTab('offensive')} className={`flex-1 py-4 text-center font-black uppercase tracking-widest transition-colors ${activeTab === 'offensive' ? 'bg-red-900/20 text-red-500 border-b-2 border-red-500' : 'text-gray-500 hover:text-gray-300 hover:bg-gray-800'}`}>Naughty Deck ({offensiveDeck.length})</button>
                            <button onClick={() => setActiveTab('defensive')} className={`flex-1 py-4 text-center font-black uppercase tracking-widest transition-colors ${activeTab === 'defensive' ? 'bg-blue-900/20 text-blue-500 border-b-2 border-blue-500' : 'text-gray-500 hover:text-gray-300 hover:bg-gray-800'}`}>Nice Deck ({defensiveDeck.length})</button>
                        </div>

                        {/* Content */}
                        <div className="flex-1 overflow-y-auto p-6 custom-scrollbar">
                            {activeTab === 'general' ? (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-3xl mx-auto">
                                    <div className="space-y-6">
                                        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
                                            <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2"><Edit2 className="w-5 h-5"/> Branding</h3>
                                            <div className="space-y-4">
                                                <div>
                                                    <label className="block text-xs font-bold uppercase text-gray-500 mb-1">Main Title</label>
                                                    <input type="text" value={gameConfig.title} onChange={(e) => handleConfigChange('title', e.target.value)} className="w-full bg-black/30 border border-gray-600 rounded-lg p-3 text-white focus:border-blue-500 outline-none" />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold uppercase text-gray-500 mb-1">Subtitle</label>
                                                    <input type="text" value={gameConfig.subtitle} onChange={(e) => handleConfigChange('subtitle', e.target.value)} className="w-full bg-black/30 border border-gray-600 rounded-lg p-3 text-white focus:border-blue-500 outline-none" />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold uppercase text-gray-500 mb-1">Header Logo URL</label>
                                                    <input type="text" value={gameConfig.logoUrl} onChange={(e) => handleConfigChange('logoUrl', e.target.value)} className="w-full bg-black/30 border border-gray-600 rounded-lg p-3 text-white text-xs font-mono focus:border-blue-500 outline-none" placeholder="https://..." />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="space-y-6">
                                        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
                                            <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2"><Power className="w-5 h-5"/> Features</h3>
                                            <div className="space-y-4">
                                                <div className="flex items-center justify-between p-3 bg-black/30 rounded-lg">
                                                    <span className="font-bold text-gray-300">Show Mini TV</span>
                                                    <button onClick={() => handleConfigChange('showTv', !gameConfig.showTv)} className={`w-12 h-6 rounded-full transition-colors relative ${gameConfig.showTv ? 'bg-green-600' : 'bg-gray-600'}`}>
                                                        <div className={`absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform ${gameConfig.showTv ? 'translate-x-6' : ''}`}></div>
                                                    </button>
                                                </div>
                                                <div className="flex items-center justify-between p-3 bg-black/30 rounded-lg">
                                                    <span className="font-bold text-gray-300">Snow Animation</span>
                                                    <button onClick={() => handleConfigChange('showSnow', !gameConfig.showSnow)} className={`w-12 h-6 rounded-full transition-colors relative ${gameConfig.showSnow ? 'bg-green-600' : 'bg-gray-600'}`}>
                                                        <div className={`absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform ${gameConfig.showSnow ? 'translate-x-6' : ''}`}></div>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {currentDeck.map((card) => (
                                        <div key={card.id} className={`p-4 rounded-xl border-2 transition-all ${editingId === card.id ? 'border-amber-500 bg-gray-800 ring-2 ring-amber-500/20' : 'border-gray-800 bg-gray-900/50 hover:border-gray-700'}`}>
                                            <div className="flex justify-between items-start mb-2">
                                                <span className="text-[10px] font-mono text-gray-600 bg-black/30 px-2 py-1 rounded uppercase tracking-widest">{card.effect}</span>
                                                <button onClick={() => setEditingId(editingId === card.id ? null : card.id)} className="text-xs text-blue-400 hover:text-white font-bold uppercase">{editingId === card.id ? 'Done' : 'Edit'}</button>
                                            </div>
                                            
                                            {editingId === card.id ? (
                                                <div className="space-y-3 animate-fade-in-up">
                                                    <div>
                                                        <label className="text-[10px] uppercase font-bold text-gray-500 block mb-1">Card Title</label>
                                                        <input type="text" value={card.title} onChange={(e) => handleUpdate(card.id, 'title', e.target.value)} className="w-full bg-black/50 border border-gray-700 rounded p-2 text-white text-sm font-bold focus:border-amber-500 outline-none" />
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] uppercase font-bold text-gray-500 block mb-1">Description</label>
                                                        <textarea value={card.desc} onChange={(e) => handleUpdate(card.id, 'desc', e.target.value)} rows={2} className="w-full bg-black/50 border border-gray-700 rounded p-2 text-gray-300 text-xs focus:border-amber-500 outline-none resize-none" />
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] uppercase font-bold text-gray-500 block mb-1">Flavor Text</label>
                                                        <input type="text" value={card.flavor} onChange={(e) => handleUpdate(card.id, 'flavor', e.target.value)} className="w-full bg-black/50 border border-gray-700 rounded p-2 text-amber-500/80 italic text-xs focus:border-amber-500 outline-none" />
                                                    </div>
                                                </div>
                                            ) : (
                                                <div onClick={() => setEditingId(card.id)} className="cursor-pointer group">
                                                    <h3 className="font-black text-white mb-1 group-hover:text-amber-400 transition-colors">{card.title}</h3>
                                                    <p className="text-xs text-gray-400 mb-2 leading-tight">{card.desc}</p>
                                                    <p className="text-[10px] text-gray-600 italic">"{card.flavor}"</p>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const Jumbotron = ({ player, logs, deckCounts }) => { 
            const visibleLogs = logs.slice(-6); 
            const logEndRef = useRef(null);
            useEffect(() => { logEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [logs]);

            return (
                <div className="w-full max-w-5xl mx-auto mb-6 relative z-30 px-2">
                    <div className={`absolute -inset-1 bg-gradient-to-r ${player.color.bg.replace('bg-', 'from-')} to-gray-900 rounded-3xl opacity-50 blur-lg animate-pulse transition-all duration-500`}></div>
                    <div className="bg-gray-900 rounded-3xl p-3 border-b-8 border-gray-800 shadow-2xl relative overflow-hidden">
                        <div className={`flex flex-col md:flex-row gap-0.5 bg-black rounded-xl border-4 ${player.color.border} overflow-hidden relative transition-colors duration-500`}>
                             <div className="absolute inset-0 scanline pointer-events-none z-10 opacity-20"></div>
                             <div className="md:w-1/3 bg-gray-950 p-6 flex flex-col items-center justify-center relative border-r-2 border-gray-800">
                                <div className="absolute top-2 left-3 flex items-center gap-2">
                                    <div className="w-2 h-2 rounded-full bg-red-600 animate-pulse"></div>
                                    <span className="text-red-600 text-[10px] font-black tracking-widest uppercase">LIVE</span>
                                </div>
                                <div className={`text-7xl mb-2 transform transition-all duration-300 hover:scale-110 filter drop-shadow-[0_0_15px_rgba(255,255,255,0.3)]`}>{player.icon}</div>
                                <h2 className={`text-3xl font-black uppercase tracking-tighter led-text text-center leading-none mb-1 ${player.color.text} drop-shadow-lg truncate w-full`}>{player.name}</h2>
                                <div className={`text-xs font-bold uppercase tracking-[0.2em] px-2 py-1 rounded bg-gray-900 ${player.color.text} border ${player.color.border} border-opacity-30`}>{player.role.name}</div>
                                {player.shield && (<div className="absolute bottom-2 right-2 flex items-center gap-1 bg-blue-900/80 text-blue-300 px-2 py-0.5 rounded text-[10px] font-bold uppercase animate-pulse border border-blue-500"><Shield className="w-3 h-3" /> Protected</div>)}
                             </div>
                             <div className="flex-1 bg-gray-950/90 relative flex flex-col h-48 md:h-auto">
                                 <div className="flex justify-between items-center p-2 border-b border-gray-800 bg-gray-900/50">
                                     <span className={`text-[10px] uppercase font-bold tracking-widest ${player.color.text}`}>DRAMA LOG</span>
                                     <span className="text-green-500 text-[10px] font-mono tracking-wider flex items-center gap-2"><span className="text-red-400">Evil: {deckCounts.naughty}</span> | <span className="text-blue-400">Good: {deckCounts.nice}</span></span>
                                 </div>
                                 <div className="flex-1 p-4 flex flex-col justify-end overflow-hidden relative">
                                     <div className="absolute inset-x-0 top-0 h-8 bg-gradient-to-b from-gray-950 to-transparent z-10 pointer-events-none"></div>
                                     {visibleLogs.map((log, i) => (
                                         <div key={i} className={`font-mono text-sm mb-1.5 leading-tight animate-fade-in-up flex items-start`}>
                                            <span className={`mr-2 opacity-50 text-[10px] mt-0.5 ${i === visibleLogs.length - 1 ? 'text-white' : 'text-gray-600'}`}>{i === visibleLogs.length - 1 ? '‚ñ∂' : '‚Ä¢'}</span>
                                            <span className={`${i === visibleLogs.length - 1 ? 'text-white font-bold text-shadow-glow' : 'text-gray-400'}`}>{log}</span>
                                         </div>
                                     ))}
                                     <div ref={logEndRef} />
                                 </div>
                             </div>
                        </div>
                    </div>
                </div>
            )
        };

        function PrebegSpanksGiving() {
          const [phase, setPhase] = useState(GAME_PHASES.SETUP_COUNT);
          const [playerCount, setPlayerCount] = useState(2);
          const [playerNames, setPlayerNames] = useState(Array(8).fill('')); 
          const [playerRoles, setPlayerRoles] = useState(Array(8).fill('drunk')); 
          const [players, setPlayers] = useState([]);
          const [currentPlayerIdx, setCurrentPlayerIdx] = useState(0);
          const [diceVal, setDiceVal] = useState(null);
          const [logs, setLogs] = useState(["Welcome to the Prebeg Chaos."]);
          const [selectedCard, setSelectedCard] = useState(null);
          const [revealedCard, setRevealedCard] = useState(null);
          const [targetMode, setTargetMode] = useState(false);
          const [showRules, setShowRules] = useState(false);
          const [showAdmin, setShowAdmin] = useState(false);
          const [activeEvent, setActiveEvent] = useState(null); 
          const [battleState, setBattleState] = useState(null); 
          const [showRiggedModal, setShowRiggedModal] = useState(false);
          const [isMuted, setIsMuted] = useState(false);
          const [floatingTexts, setFloatingTexts] = useState({});
          
          // New Game Config State
          const [gameConfig, setGameConfig] = useState({
              title: "Prebeg Christmas",
              subtitle: "Family Edition",
              logoUrl: "https://i.postimg.cc/KY7vmKVH/image.png",
              showTv: true,
              showSnow: true
          });
          
          // Card Libraries (Editable State)
          const [libraryOffensive, setLibraryOffensive] = useState(OFFENSIVE_DECK);
          const [libraryDefensive, setLibraryDefensive] = useState(DEFENSIVE_DECK);

          const [offensivePile, setOffensivePile] = useState([]);
          const [defensivePile, setDefensivePile] = useState([]);
          const [turnSnapshot, setTurnSnapshot] = useState(null);
          const fileInputRef = useRef(null);

          const resetDecks = () => {
              setLibraryOffensive(OFFENSIVE_DECK);
              setLibraryDefensive(DEFENSIVE_DECK);
              addLog("üîÑ Decks reset to default factory trauma.");
              SoundEngine.play('click');
          };

          const addLog = (msg) => setLogs(prev => [...prev, msg]);

          const showFloatText = (playerId, text) => {
              setFloatingTexts(prev => ({...prev, [playerId]: text}));
              setTimeout(() => { setFloatingTexts(prev => { const next = {...prev}; delete next[playerId]; return next; }); }, 2000);
          };
          
          const shuffleDeck = (deck) => [...deck].sort(() => Math.random() - 0.5);

          const initNameSetup = (count) => {
            SoundEngine.play('click');
            setPlayerCount(count);
            const defaults = Array.from({ length: count }).map((_, i) => `Player ${i + 1}`);
            setPlayerNames(prev => { const newNames = [...prev]; defaults.forEach((name, i) => newNames[i] = name); return newNames; });
            const roleKeys = Object.keys(ROLES);
            setPlayerRoles(Array.from({ length: count }).map((_, i) => roleKeys[i % roleKeys.length].toLowerCase()));
            setPhase(GAME_PHASES.SETUP_NAMES);
          };

          const finalizeSetup = () => {
            SoundEngine.play('success');
            const newPlayers = Array.from({ length: playerCount }).map((_, i) => createPlayer(i, playerNames[i], playerRoles[i]));
            setPlayers(newPlayers);
            // Use the Library state to initialize the piles
            setOffensivePile(shuffleDeck(libraryOffensive));
            setDefensivePile(shuffleDeck(libraryDefensive));
            setPhase(GAME_PHASES.START_TURN);
            addLog("üç∫ Let the games begin!");
            addLog(`üëâ ${newPlayers[0].name}'s turn.`);
            setTurnSnapshot({ players: JSON.parse(JSON.stringify(newPlayers)), currentPlayerIdx: 0, logs: ["üç∫ Game Start!"], phase: GAME_PHASES.START_TURN });
          };
          
          const createPlayer = (i, name, roleId) => {
              let roleKey = Object.keys(ROLES).find(key => ROLES[key].id === roleId) || Object.keys(ROLES)[0];
              const roleData = ROLES[roleKey];
              const p = {
                id: i, name: name.trim() || `Player ${i + 1}`, color: COLORS[i], icon: COLORS[i].icon, role: roleData,
                pos: 0, cards: [], shield: false, skipTurns: 0, doubleRoll: false, usedRigged: false,
              };
              if (roleData.id === 'prude' || roleData.id === 'dog') p.shield = true;
              if (roleData.id === 'drunk') p.cards.push(DRUNK_CARD);
              if (roleData.id === 'dad') p.cards.push(DAD_BELT_CARD);
              if (roleData.id === 'mom') p.cards.push(MOM_GUILT_CARD);
              return p;
          };

          const rollDice = () => {
            SoundEngine.play('roll');
            const player = players[currentPlayerIdx];
            let rolls = 0;
            const interval = setInterval(() => {
              setDiceVal(Math.floor(Math.random() * 6) + 1);
              rolls++;
              if (rolls > 15) { clearInterval(interval); finalizeRoll(player); }
            }, 50);
          };

          const finalizeRoll = (player) => {
            let roll = Math.floor(Math.random() * 6) + 1;
            let msg = `${player.name} rolled a ${roll}!`;
            let actualRoll = roll;
            if (player.doubleRoll) {
              const roll2 = Math.floor(Math.random() * 6) + 1;
              actualRoll += roll2;
              msg = `${player.name} popped a "Vitamin"! Double: ${actualRoll - roll2} + ${roll2} = ${actualRoll}!`;
              const updated = [...players];
              updated[currentPlayerIdx].doubleRoll = false;
              setPlayers(updated);
            }
            setDiceVal(actualRoll);
            addLog(msg);
            showFloatText(player.id, `+${actualRoll}`);
            setTimeout(() => { animateMovement(currentPlayerIdx, actualRoll); }, 600);
          };

          const handleCheat = () => {
            if (phase !== GAME_PHASES.START_TURN) return;
            SoundEngine.play('click');
            const isSuccess = Math.random() > 0.8; 
            const player = players[currentPlayerIdx];
            if (isSuccess) {
              SoundEngine.play('success');
              addLog(`üïµÔ∏è‚Äç‚ôÇÔ∏è ${player.name} cheated! Uncle Mike would be proud! +5!`);
              showFloatText(player.id, "+5 (Sneaky!)");
              animateMovement(currentPlayerIdx, 5);
            } else {
              SoundEngine.play('fail');
              addLog(`üëÄ CAUGHT! Aunt Karen saw you! Back 5!`);
              showFloatText(player.id, "-5 (Busted!)");
              const karens = players.filter(p => p.id !== player.id && p.role.id === 'karen');
              let bonusAnimations = [];
              if (karens.length > 0) {
                karens.forEach(tt => {
                   addLog(`üì¢ ${tt.name} (Karen) demands manager! +3!`);
                   showFloatText(tt.id, "+3 (Bitch!)");
                   bonusAnimations.push(tt.id);
                });
              }
              animateMovement(currentPlayerIdx, -5, () => {
                 if (bonusAnimations.length > 0) {
                   setPlayers(prev => { const copy = [...prev]; bonusAnimations.forEach(id => { copy[id].pos = Math.min(BOARD_SIZE, copy[id].pos + 3); }); return copy; });
                   SoundEngine.play('success');
                 }
                 setTimeout(endTurn, 1500);
              });
            }
          };

          const handleRiggedClick = () => { SoundEngine.play('fail'); setShowRiggedModal(true); };

          const resolveRigged = (pity) => {
              const newPlayers = [...players];
              const player = newPlayers[currentPlayerIdx];
              player.usedRigged = true;
              if (pity) {
                  SoundEngine.play('success');
                  player.pos = Math.min(BOARD_SIZE, player.pos + 3);
                  showFloatText(player.id, "+3 (Pathetic)");
                  addLog(`üçº Everyone pities ${player.name}. +3 Spaces.`);
              } else {
                  SoundEngine.play('fail');
                  showFloatText(player.id, "Denied!");
                  addLog(`‚ùÑÔ∏è "Life's not fair." - Dad.`);
              }
              setPlayers(newPlayers);
              setShowRiggedModal(false);
          };

          const animateMovement = (pIdx, steps, onComplete = null) => {
            setPhase(GAME_PHASES.MOVING);
            let stepsRemaining = Math.abs(steps);
            const direction = steps > 0 ? 1 : -1;
            const moveInterval = setInterval(() => {
              setPlayers(prevPlayers => {
                const newPlayers = [...prevPlayers];
                let nextPos = newPlayers[pIdx].pos + direction;
                if (nextPos > BOARD_SIZE) nextPos = BOARD_SIZE;
                if (nextPos < 0) nextPos = 0;
                newPlayers[pIdx].pos = nextPos;
                return newPlayers;
              });
              SoundEngine.play('step');
              stepsRemaining--;
              if (stepsRemaining <= 0) {
                clearInterval(moveInterval);
                setTimeout(() => { if (onComplete) onComplete(); else handleMovementEnd(pIdx); }, 300);
              }
            }, 200);
          };

          const handleMovementEnd = (pIdx) => {
            const player = players[pIdx]; 
            const finalPos = player.pos;
            if (finalPos >= BOARD_SIZE) {
              setPhase(GAME_PHASES.GAME_OVER);
              SoundEngine.play('win');
              addLog(`üèÜ ${player.name} WON! EVERYONE ELSE DRINK! üèÜ`);
              return;
            }
            if (finalPos > 0 && finalPos < BOARD_SIZE) {
              const defenders = players.filter(p => p.id !== player.id && p.pos === finalPos);
              if (defenders.length > 0) {
                startBattle(player, defenders[0]);
                return;
              }
            }
            checkTileEffect(pIdx);
          };

          const checkTileEffect = (pIdx) => {
             const player = players[pIdx];
             const tile = SPECIAL_TILES[player.pos];
             
             if (tile) {
                const newPlayers = [...players];
                const active = newPlayers[pIdx];

                if (tile.label === 'Uncle Jim') {
                    if (active.role.id === 'stoner') {
                        addLog(`ü•¨ ${active.name} sat with Uncle Jim. Immune.`);
                        showFloatText(active.id, "Chilling");
                    } else {
                        addLog(`üò¥ ${active.name} tripped over Uncle Jim. Skip turn.`);
                        showFloatText(active.id, "Zzz...");
                        SoundEngine.play('fail');
                        active.skipTurns = 1;
                        setPlayers(newPlayers);
                    }
                } else if (tile.label === 'Aunt Karen') {
                    addLog(`ü§¨ Aunt Karen cornered ${active.name}. Skip turn.`);
                    showFloatText(active.id, "Trapped!");
                    SoundEngine.play('fail');
                    active.skipTurns = 1;
                    setPlayers(newPlayers);
                } else if (tile.label === 'Dog Puked') {
                    addLog(`ü§Æ Sparky puked on ${active.name}. Back 1.`);
                    showFloatText(active.id, "-1 Puke");
                    SoundEngine.play('fail');
                    active.pos = Math.max(0, active.pos - 1);
                    setPlayers(newPlayers);
                } else if (tile.label === 'Cousin Nick') {
                    addLog(`üíä Cousin Nick gave ${active.name} something weird. Double roll next.`);
                    showFloatText(active.id, "Whoa!");
                    SoundEngine.play('shield');
                    active.doubleRoll = true;
                    setPlayers(newPlayers);
                }
             }
             setTimeout(() => { checkPostMove(pIdx); }, 800);
          };

          const checkPostMove = (pIdx) => {
            const rollEvent = Math.random();
            if (rollEvent < 0.25) { 
              triggerRandomEvent(players[pIdx]);
            } else {
              setPhase(GAME_PHASES.DRAW_CHOICE);
            }
          };

          const startBattle = (attacker, defender) => {
            SoundEngine.play('alert');
            setBattleState({ attacker, defender, step: 'FIGHT_INTRO', winner: null });
            addLog(`‚öîÔ∏è FIGHT! ${attacker.name} vs ${defender.name}!`);
          };

          const handleFight = () => {
            const { attacker, defender } = battleState;
            SoundEngine.play('alert');
            const isAttackerWinner = Math.random() > 0.5;
            const winnerId = isAttackerWinner ? attacker.id : defender.id;
            const loserId = isAttackerWinner ? defender.id : attacker.id;
            
            setBattleState(prev => ({ ...prev, step: 'FIGHT_RESULT', winner: winnerId, loser: loserId }));
            const resultSound = (winnerId === currentPlayerIdx) ? 'win' : 'fail';
            SoundEngine.play(resultSound);
          };

          const finalizeBattle = () => {
            const { loser } = battleState;
            const newPlayers = [...players];
            const loserIdx = newPlayers.findIndex(p => p.id === loser);
            newPlayers[loserIdx].pos = Math.max(0, newPlayers[loserIdx].pos - 1);
            showFloatText(loser, "Bitch Slapped! -1");
            setPlayers(newPlayers);
            const loserName = newPlayers[loserIdx].name;
            addLog(`ü•ä ${loserName} got knocked out! (-1)`);
            setBattleState(null);
            checkTileEffect(currentPlayerIdx);
          };

          const triggerRandomEvent = (player) => {
            SoundEngine.play('alert');
            const EVENTS_POOL = [
                { type: 'good', title: 'Uncle Bob\'s Wallet', desc: 'You found it in the couch.', execute: (newPlayers) => { const idx = newPlayers.findIndex(p => p.id === player.id); newPlayers[idx].pos = Math.min(BOARD_SIZE, newPlayers[idx].pos + 3); return `üçÄ ${player.name} found Uncle Bob's cash. +3 spaces!`; } },
                { type: 'good', title: 'Grandma\'s Favorite', desc: 'She slipped you a cookie.', execute: (newPlayers) => { const idx = newPlayers.findIndex(p => p.id === player.id); newPlayers[idx].pos = Math.min(BOARD_SIZE, newPlayers[idx].pos + 2); return `üëµ ${player.name} is Grandma's favorite! +2 spaces!`; } },
                { type: 'bad', title: 'Dad\'s Lecture', desc: 'He cornered you about your career.', execute: (newPlayers) => { const idx = newPlayers.findIndex(p => p.id === player.id); newPlayers[idx].pos = Math.max(0, newPlayers[idx].pos - 3); return `üëî Dad talked for hours. ${player.name} moves back 3.`; } },
                // New Events
                { type: 'good', title: 'Mike\'s Money', desc: 'She slipped you a $20.', execute: (newPlayers) => { const idx = newPlayers.findIndex(p => p.id === player.id); newPlayers[idx].pos = Math.min(BOARD_SIZE, newPlayers[idx].pos + 3); return `üçÄ ${player.name} got Mike's Money! +3 spaces!`; } },
                { type: 'good', title: 'Found the Booze', desc: 'Found Uncle Guy\'s secret stash.', execute: (newPlayers) => { const idx = newPlayers.findIndex(p => p.id === player.id); newPlayers[idx].pos = Math.min(BOARD_SIZE, newPlayers[idx].pos + 2); return `üçÄ ${player.name} found the booze! +2 spaces!`; } },
                { type: 'bad', title: 'The Ex Called', desc: 'Max\'s crazy ex is on the landline.', execute: (newPlayers) => { const idx = newPlayers.findIndex(p => p.id === player.id); newPlayers[idx].pos = Math.max(0, newPlayers[idx].pos - 3); return `ü§¨ The Ex Called! ${player.name} moves back 3.`; } },
            ];
            const randomEvent = EVENTS_POOL[Math.floor(Math.random() * EVENTS_POOL.length)];
            const eventData = {
                type: randomEvent.type, title: randomEvent.title, desc: randomEvent.desc,
                effect: () => {
                    const newPlayers = [...players];
                    const logMsg = randomEvent.execute(newPlayers);
                    addLog(logMsg);
                    setPlayers(newPlayers);
                }
            };
            setActiveEvent(eventData);
            setPhase(GAME_PHASES.EVENT_TRIGGER);
          };

          const resolveEvent = () => { activeEvent.effect(); setActiveEvent(null); setPhase(GAME_PHASES.DRAW_CHOICE); };

          const drawMysteryCard = () => {
            SoundEngine.play('click');
            const isOffensive = Math.random() > 0.5;
            let card;
            let newOffensive = [...offensivePile];
            let newDefensive = [...defensivePile];

            if (isOffensive) {
                if (newOffensive.length === 0) { 
                    newOffensive = shuffleDeck(libraryOffensive); // Reshuffle from edited library
                    addLog("‚ò†Ô∏è Offensive Deck Reshuffled!"); 
                }
                card = newOffensive.pop();
                setOffensivePile(newOffensive);
            } else {
                if (newDefensive.length === 0) { 
                    newDefensive = shuffleDeck(libraryDefensive); // Reshuffle from edited library
                    addLog("üõ°Ô∏è Defensive Deck Reshuffled!"); 
                }
                card = newDefensive.pop();
                setDefensivePile(newDefensive);
            }
            setRevealedCard(card);
            setPhase(GAME_PHASES.CARD_REVEAL);
            SoundEngine.play(isOffensive ? 'fail' : 'success');
            
            setTimeout(() => {
                const cardElement = document.getElementById('revealed-card');
                if(cardElement) cardElement.classList.add('animate-drop-to-hand');
                setTimeout(() => {
                    const newPlayers = [...players];
                    newPlayers[currentPlayerIdx].cards.push(card);
                    setPlayers(newPlayers);
                    addLog(`${newPlayers[currentPlayerIdx].name} drew "${card.title}"!`);
                    showFloatText(newPlayers[currentPlayerIdx].id, `+Card`);
                    setRevealedCard(null);
                    endTurn();
                }, 800);
            }, 2500); 
          };

          const playCard = (cardIndex) => {
            SoundEngine.play('click');
            setSelectedCard({ ...players[currentPlayerIdx].cards[cardIndex], index: cardIndex });
            setTargetMode(true);
          };

          const executeCardEffect = (targetId) => {
            const sourcePlayer = players[currentPlayerIdx];
            const card = selectedCard;
            const newPlayers = [...players];
            const target = newPlayers[targetId];
            let blocked = false;

            if (targetId !== currentPlayerIdx && target.shield && (card.id.startsWith('o_') || card.id === 'special_belt')) {
              blocked = true; target.shield = false; 
              addLog(`üõ°Ô∏è ${target.name} blocked ${sourcePlayer.name}!`);
              showFloatText(targetId, "BLOCKED!");
              SoundEngine.play('shield');
            }

            if (!blocked) {
              if (card.effect === 'skip_turn' && target.role.id === 'stoner') {
                addLog(`ü•¨ ${target.name} (Stoner) doesn't care. Immune!`);
                showFloatText(targetId, "Immune!");
                SoundEngine.play('fail');
              } else if (card.id === 'o_mooch' && target.role.id === 'mooch') {
                addLog(`ü§ë ${target.name} (Mooch) won't pay up. Immune.`);
                showFloatText(targetId, "Cheapskate!");
                SoundEngine.play('fail');
              } else {
                addLog(`üÉè ${sourcePlayer.name} used "${card.title}" on ${target.name}.`);
                SoundEngine.play('success');
                switch (card.effect) {
                  case 'move_forward': target.pos = Math.min(BOARD_SIZE, target.pos + card.value); addLog(`${target.name} moved forward ${card.value} spaces.`); showFloatText(targetId, `+${card.value}`); break;
                  case 'move_back': let val = card.value; if (sourcePlayer.role.id === 'grinch') { val += 1; addLog(`üñï Asshole Bonus! (+1 Push)`); } target.pos = Math.max(0, target.pos - val); addLog(`${target.name} was pushed back ${val} spaces.`); showFloatText(targetId, `-${val}`); break;
                  case 'skip_turn': target.skipTurns = 1; addLog(`${target.name} skips next turn.`); showFloatText(targetId, "Skipped!"); break;
                  case 'skip_turn_2': target.skipTurns = 2; addLog(`${target.name} skips 2 turns!`); showFloatText(targetId, "Skip x2!"); break;
                  case 'global_skip': newPlayers.forEach(p => { if (p.id !== sourcePlayer.id) p.skipTurns = 1; }); addLog("üåç PARTY FOUL! Everyone else skips a turn!"); showFloatText(sourcePlayer.id, "RUINED IT"); break;
                  case 'shield': target.shield = true; addLog(`${target.name} is protected.`); showFloatText(targetId, "Shielded"); break;
                  case 'double_roll': target.doubleRoll = true; addLog(`${target.name} will roll double.`); showFloatText(targetId, "Double Roll!"); break;
                  case 'swap': const tempPos = sourcePlayer.pos; newPlayers[currentPlayerIdx].pos = target.pos; newPlayers[targetId].pos = tempPos; addLog(`${sourcePlayer.name} swapped places with ${target.name}!`); showFloatText(targetId, "Swapped!"); break;
                  case 'swap_last': let minP = 0; let minVal = 100; newPlayers.forEach((p, idx) => { if (p.pos < minVal) { minVal = p.pos; minP = idx; } }); const tPos = newPlayers[targetId].pos; newPlayers[targetId].pos = newPlayers[minP].pos; newPlayers[minP].pos = tPos; addLog(`‚ò†Ô∏è ${target.name} swapped with Last Place (${newPlayers[minP].name})!`); showFloatText(targetId, "GET REKT"); break;
                  case 'discard_hand': target.cards = []; addLog(`${target.name} lost their hand!`); showFloatText(targetId, "Hand Lost!"); break;
                  case 'draw_card': let dCard; const isN = Math.random() > 0.5; let nOff = [...offensivePile]; let nDef = [...defensivePile]; if (isN) { if (nOff.length === 0) nOff = shuffleDeck(OFFENSIVE_DECK); dCard = nOff.pop(); setOffensivePile(nOff); } else { if (nDef.length === 0) nDef = shuffleDeck(DEFENSIVE_DECK); dCard = nDef.pop(); setDefensivePile(nDef); } target.cards.push(dCard); addLog(`${target.name} got a card.`); showFloatText(targetId, "+1 Card"); break;
                  case 'goto_leader': let maxP = 0; let maxVal = -1; newPlayers.forEach((p, idx) => { if (p.pos > maxVal && p.pos < BOARD_SIZE) { maxVal = p.pos; maxP = idx; } }); target.pos = maxVal; addLog(`üöï Uber arrived! ${target.name} warped to the leader!`); showFloatText(targetId, "WARP!"); break;
                  case 'steal_2': let victims = newPlayers.filter(p => p.id !== sourcePlayer.id && p.cards.length > 0); victims = victims.sort(() => 0.5 - Math.random()).slice(0, 2); victims.forEach(v => { const stolen = v.cards.pop(); newPlayers[currentPlayerIdx].cards.push(stolen); addLog(`üñï ${sourcePlayer.name} stole "${stolen.title}" from ${v.name}!`); showFloatText(v.id, "STOLEN!"); }); if (victims.length === 0) addLog("üñï No one had cards to steal! Lame."); break;
                  case 'global_reset_hands': 
                    newPlayers.forEach(p => { p.cards = []; showFloatText(p.id, "Hand Lost!"); });
                    addLog("üéÖ Saint Maxwell took everyone's toys! All hands reset.");
                    break;
                }
              }
            }
            newPlayers[currentPlayerIdx].cards.splice(card.index, 1);
            setPlayers(newPlayers);
            setTargetMode(false);
            setSelectedCard(null);
          };

          const endTurn = () => {
            let nextIdx = (currentPlayerIdx + 1) % players.length;
            let checks = 0;
            while (players[nextIdx].skipTurns > 0 && checks < players.length) {
              const pName = players[nextIdx].name;
              addLog(`üí§ ${pName} is passed out (${players[nextIdx].skipTurns} turns).`);
              const newPlayers = [...players];
              newPlayers[nextIdx].skipTurns -= 1;
              setPlayers(newPlayers);
              nextIdx = (nextIdx + 1) % players.length;
              checks++;
            }
            setCurrentPlayerIdx(nextIdx);
            setPhase(GAME_PHASES.TURN_TRANSITION); 
          };

          const startNextTurn = () => {
             SoundEngine.play('success');
             setPhase(GAME_PHASES.START_TURN);
             addLog(`üëâ It is now ${players[currentPlayerIdx].name}'s turn.`);
             setDiceVal(null);
             setTurnSnapshot({ players: JSON.parse(JSON.stringify(players)), currentPlayerIdx: currentPlayerIdx, logs: [...logs, `üëâ It is now ${players[currentPlayerIdx].name}'s turn.`], phase: GAME_PHASES.START_TURN });
          };
          
          const toggleMute = () => { const muted = SoundEngine.toggleMute(); setIsMuted(muted); };
          
          const saveGame = () => {
             const stateToSave = { 
                 players, currentPlayerIdx, phase, logs, playerCount, playerNames, playerRoles, offensivePile, defensivePile,
                 libraryOffensive, libraryDefensive, gameConfig // Save config
             };
             const blob = new Blob([JSON.stringify(stateToSave)], {type: 'application/json'});
             const url = URL.createObjectURL(blob);
             const a = document.createElement('a'); a.href = url; a.download = `christmas-chaos-save.json`; a.click();
             addLog("üíæ Game Saved!"); SoundEngine.play('success');
          };
          
          const loadGame = (e) => {
              const file = e.target.files[0]; if (!file) return;
              const reader = new FileReader();
              reader.onload = (ev) => {
                  try {
                      const data = JSON.parse(ev.target.result);
                      setPlayers(data.players); setCurrentPlayerIdx(data.currentPlayerIdx); setPhase(data.phase); setLogs(data.logs);
                      setPlayerCount(data.playerCount); setPlayerNames(data.playerNames); setPlayerRoles(data.playerRoles);
                      if (data.offensivePile) setOffensivePile(data.offensivePile);
                      if (data.defensivePile) setDefensivePile(data.defensivePile);
                      // Load custom decks
                      if (data.libraryOffensive) setLibraryOffensive(data.libraryOffensive);
                      if (data.libraryDefensive) setLibraryDefensive(data.libraryDefensive);
                      // Load config
                      if (data.gameConfig) setGameConfig(data.gameConfig);
                      
                      addLog("üìÇ Game Loaded!"); SoundEngine.play('success');
                  } catch (err) { addLog("‚ùå Load Failed."); SoundEngine.play('fail'); }
              };
              reader.readAsText(file);
          };
          
          const handleMulligan = () => {
              if (!turnSnapshot) { addLog("‚ùå No turn to Mulligan."); SoundEngine.play('fail'); return; }
              if (confirm("Redo turn?")) { setPlayers(turnSnapshot.players); setCurrentPlayerIdx(turnSnapshot.currentPlayerIdx); setLogs([...turnSnapshot.logs, "‚Ü∫ Mulligan!"]); setPhase(turnSnapshot.phase); setDiceVal(null); SoundEngine.play('alert'); }
          };
          
          const flipTable = () => {
              if (confirm("RAGE QUIT AND RESET?")) {
                  const resetPlayers = players.map(p => createPlayer(p.id, p.name, p.role.id));
                  setPlayers(resetPlayers); setCurrentPlayerIdx(0); setPhase(GAME_PHASES.START_TURN); setDiceVal(null);
                  setLogs(["(‚ïØ¬∞‚ñ°¬∞Ôºâ‚ïØÔ∏µ ‚îª‚îÅ‚îª TABLE FLIPPED!", `üëâ ${resetPlayers[0].name}'s turn.`]);
                  setOffensivePile(shuffleDeck(OFFENSIVE_DECK)); setDefensivePile(shuffleDeck(DEFENSIVE_DECK));
                  setTurnSnapshot({ players: JSON.parse(JSON.stringify(resetPlayers)), currentPlayerIdx: 0, logs: [], phase: GAME_PHASES.START_TURN });
                  SoundEngine.play('fail');
              }
          };

          const renderPath = () => {
             const points = [];
             for (let i = 0; i <= BOARD_SIZE; i++) {
               let row = Math.floor(i / GRID_COLS);
               let col = (row % 2 === 0) ? i % GRID_COLS : (GRID_COLS - 1) - (i % GRID_COLS);
               const x = 10 + (col * 20); const y = 8.33 + (row * (100/GRID_ROWS)); 
               points.push(`${x},${y}`);
             }
             const pathD = `M ${points.join(' L ')}`;
             
             // Create "Lights" along the path
             const lights = points.map((p, i) => {
                 const [x, y] = p.split(',').map(Number);
                 if (i === points.length - 1) return null;
                 const nextP = points[i+1].split(',').map(Number);
                 const midX = (x + nextP[0]) / 2;
                 const midY = (y + nextP[1]) / 2;
                 const color = ['#ef4444', '#22c55e', '#eab308', '#3b82f6'][i % 4];
                 return <circle key={i} cx={midX} cy={midY} r="1" fill={color} className="animate-pulse" style={{animationDelay: `${i*0.1}s`}} filter="url(#glow)"/>;
             });

             return (
                 <svg className="absolute inset-0 w-full h-full pointer-events-none z-0" viewBox="0 0 100 100" preserveAspectRatio="none">
                     <defs>
                        <filter id="glow">
                            <feGaussianBlur stdDeviation="0.5" result="coloredBlur"/>
                            <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>
                        </filter>
                     </defs>
                     <path d={pathD} fill="none" stroke="#14532d" strokeWidth="1.5" strokeOpacity="0.8" strokeLinecap="round" />
                     {lights}
                 </svg>
             );
          };

          const renderBoard = () => {
            const gridCells = [];
            for (let r = 0; r < GRID_ROWS; r++) {
               for (let c = 0; c < GRID_COLS; c++) {
                  const visualIndex = r * GRID_COLS + c;
                  let logicalIndex = (r % 2 === 0) ? r * GRID_COLS + c : r * GRID_COLS + (GRID_COLS - 1 - c);
                  if (logicalIndex > BOARD_SIZE) { gridCells.push(<div key={visualIndex}></div>); continue; }
                  const occupants = players.filter(p => p.pos === logicalIndex);
                  const isStart = logicalIndex === 0;
                  const isEnd = logicalIndex === BOARD_SIZE;
                  const special = SPECIAL_TILES[logicalIndex];
                  let tileStyle = 'plate'; 
                  let content = <span className="absolute top-1 left-2 text-[10px] md:text-xs font-bold text-gray-500 opacity-50">{logicalIndex}</span>;
                  if (isStart) { tileStyle = 'plate start-tile'; content = <span className="text-[10px] font-black text-white uppercase tracking-wider relative z-10 drop-shadow-md">Start</span>; } 
                  else if (isEnd) { tileStyle = 'plate end-tile'; content = <div className="flex flex-col items-center relative z-10"><Skull className="w-5 h-5 md:w-8 md:h-8 animate-pulse text-red-900" /><span className="text-[9px] font-black uppercase text-white drop-shadow-md">WINNER</span></div>; } 
                  else if (special) { content = <><span className="absolute top-1 left-2 text-[10px] md:text-xs font-bold text-yellow-800/30">{logicalIndex}</span><div className="flex flex-col items-center opacity-80 mt-1 relative z-10"><span className="text-lg md:text-2xl transform hover:scale-125 transition-transform">{special.icon}</span><span className="text-[8px] md:text-[9px] font-bold text-amber-200 leading-none uppercase drop-shadow-sm">{special.label}</span></div></>; }
                  gridCells.push(
                    <div key={visualIndex} className={`relative w-full aspect-square flex flex-col items-center justify-center transition-all z-10 ${tileStyle}`}>
                      {content}
                      <div className="absolute inset-0 flex flex-wrap justify-center items-center gap-0.5 p-1 pointer-events-none z-20">
                        {occupants.map((p, i) => (<div key={p.id} className="absolute transition-all duration-500" style={{ left: '50%', top: '50%', transform: `translate(-50%, -50%) translate(${(i%2)*8}px, ${Math.floor(i/2)*-8}px)`, zIndex: 30+i }}><PlayerToken player={p} isActive={currentPlayerIdx === p.id} floatText={floatingTexts[p.id]} /></div>))}
                      </div>
                    </div>
                  );
               }
            }
            return gridCells;
          };

          const minPos = players.length > 0 ? Math.min(...players.map(p => p.pos)) : 0;
          const canUseRigged = phase === GAME_PHASES.START_TURN && players.length > 0 && players[currentPlayerIdx].pos === minPos && !players[currentPlayerIdx].usedRigged;

          return (
            <div className="min-h-screen bg-slate-950 font-sans text-gray-200 select-none pb-24 overflow-x-hidden">
              {gameConfig.showSnow && <Snow />}
              {gameConfig.showTv && <MiniTV />}
              {phase === GAME_PHASES.GAME_OVER && <Confetti />}
              
              {/* Admin Panel */}
              <AdminPanel 
                  isOpen={showAdmin} 
                  onClose={() => setShowAdmin(false)} 
                  offensiveDeck={libraryOffensive}
                  setOffensiveDeck={setLibraryOffensive}
                  defensiveDeck={libraryDefensive}
                  setDefensiveDeck={setLibraryDefensive}
                  onReset={resetDecks}
                  gameConfig={gameConfig}
                  setGameConfig={setGameConfig}
              />

              {/* Event Modal */}
              {activeEvent && phase === GAME_PHASES.EVENT_TRIGGER && (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                  <div className={`bg-gray-800 rounded-3xl p-8 max-w-md w-full shadow-2xl animate-pop-in border-4 ${activeEvent.type === 'good' ? 'border-green-600' : 'border-red-600'}`}>
                    <div className="text-7xl text-center mb-6 animate-bounce">{activeEvent.type === 'good' ? 'üçÄ' : 'ü§¨'}</div>
                    <h3 className={`text-3xl font-black text-center mb-4 uppercase tracking-tight ${activeEvent.type === 'good' ? 'text-green-400' : 'text-red-400'}`}>{activeEvent.title}</h3>
                    <p className="text-center text-gray-300 font-bold text-lg mb-8 leading-relaxed">{activeEvent.desc}</p>
                    <button onClick={resolveEvent} className={`w-full py-4 rounded-2xl font-black text-white text-2xl shadow-lg hover:scale-105 transition-transform ${activeEvent.type === 'good' ? 'bg-green-600' : 'bg-red-600'}`}>{activeEvent.type === 'good' ? 'Awesome' : 'F***'}</button>
                  </div>
                </div>
              )}

              {/* Card Reveal Modal */}
              {phase === GAME_PHASES.CARD_REVEAL && revealedCard && (
                  <div className="fixed inset-0 bg-black/90 backdrop-blur-md z-[70] flex flex-col items-center justify-center p-4">
                      <div id="revealed-card" className="transform scale-100 md:scale-110 transition-all duration-300"><Card card={revealedCard} isRevealed={true} /></div>
                      <div className="mt-12 text-white font-black text-3xl uppercase tracking-widest animate-pulse">Adding to Hand...</div>
                  </div>
              )}

              {/* Rigged Modal */}
              {showRiggedModal && (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
                    <div className="bg-pink-900 rounded-3xl p-8 max-w-lg w-full shadow-2xl border-8 border-pink-500 text-center animate-pop-in relative">
                         <div className="absolute -top-12 left-1/2 -translate-x-1/2 text-9xl filter drop-shadow-lg">üò≠</div>
                         <h2 className="text-4xl font-black text-pink-300 mt-12 mb-4">Baby Rage!</h2>
                         <p className="text-xl font-bold text-gray-200 mb-8 italic">"{players[currentPlayerIdx].name} is crying about the RNG!"</p>
                         <div className="bg-gray-800 p-4 rounded-xl border-2 border-pink-700 mb-8 shadow-inner"><p className="text-lg font-bold text-gray-200">Vote: Give them a pity boost?</p></div>
                         <div className="grid grid-cols-2 gap-4">
                            <button onClick={() => resolveRigged(true)} className="bg-green-600 text-white py-4 rounded-xl font-black text-xl shadow hover:scale-105 transition-transform">Yes (+3)</button>
                            <button onClick={() => resolveRigged(false)} className="bg-red-600 text-white py-4 rounded-xl font-black text-xl shadow hover:scale-105 transition-transform">NO! (Cry more)</button>
                         </div>
                    </div>
                </div>
              )}

              {/* Turn Transition */}
              {phase === GAME_PHASES.TURN_TRANSITION && (
                 <div className="fixed inset-0 bg-gray-950 z-50 flex flex-col items-center justify-center p-6 text-center animate-in fade-in duration-500">
                    <div className="mb-8 relative">
                        <div className="absolute inset-0 bg-yellow-500 blur-3xl opacity-20 rounded-full animate-pulse"></div>
                        <Beer className="w-32 h-32 text-yellow-500 relative z-10" />
                    </div>
                    <h2 className="text-5xl md:text-7xl font-black text-white mb-4 uppercase tracking-tighter drop-shadow-lg">Pass The Device</h2>
                    <p className="text-2xl text-gray-400 mb-12 font-bold max-w-md mx-auto">Don't let <span className="text-red-500">{players[(currentPlayerIdx + players.length - 1) % players.length].name}</span> see your cards!</p>
                    <div className="bg-white/10 p-8 rounded-3xl backdrop-blur-md border border-white/20 mb-12 transform hover:scale-105 transition-transform">
                       <p className="text-gray-400 text-sm font-bold uppercase mb-2 tracking-widest">Next Victim</p>
                       <div className="flex items-center justify-center gap-6 text-5xl text-white font-black">
                          <span className="text-7xl filter drop-shadow-md">{players[currentPlayerIdx].icon}</span>
                          {players[currentPlayerIdx].name}
                       </div>
                    </div>
                    <button onClick={startNextTurn} className="bg-white text-slate-900 px-16 py-6 rounded-full font-black text-3xl shadow-[0_0_40px_rgba(255,255,255,0.3)] hover:scale-105 transition-transform flex items-center gap-4 hover:bg-gray-100">
                        I am Ready <ArrowRight className="w-8 h-8" />
                    </button>
                 </div>
              )}

              <header className="bg-gray-900/95 backdrop-blur-md text-gray-200 p-3 shadow-2xl sticky top-0 z-40 border-b-4 border-gray-800">
                <div className="max-w-6xl mx-auto flex justify-between items-center">
                    <div className="flex items-center gap-4">
                        <img src={gameConfig.logoUrl} alt="Logo" className="h-24 md:h-32 object-contain drop-shadow-xl hover:rotate-2 transition-transform" />
                    </div>
                    <div className="hidden md:flex gap-2">
                        <button onClick={() => setShowAdmin(true)} className="p-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-xs font-bold border border-gray-600 transition-colors flex items-center gap-1"><Settings className="w-4 h-4"/> ADMIN</button>
                        <button onClick={saveGame} className="p-2 bg-blue-900/50 hover:bg-blue-800 rounded-lg text-xs font-bold border border-blue-700 transition-colors"><Save className="w-4 h-4 mx-auto mb-1"/>SAVE</button>
                        <button onClick={() => fileInputRef.current.click()} className="p-2 bg-indigo-900/50 hover:bg-indigo-800 rounded-lg text-xs font-bold border border-indigo-700 transition-colors"><Upload className="w-4 h-4 mx-auto mb-1"/>LOAD<input type="file" ref={fileInputRef} onChange={loadGame} className="hidden" accept=".json" /></button>
                        <button onClick={handleMulligan} className="p-2 bg-amber-900/50 hover:bg-amber-800 rounded-lg text-xs font-bold border border-amber-700 transition-colors"><RotateCcw className="w-4 h-4 mx-auto mb-1"/>UNDO</button>
                        <button onClick={toggleMute} className={`p-2 rounded-lg text-xs font-bold border transition-colors ${isMuted ? 'bg-gray-800 border-gray-600 text-gray-500' : 'bg-green-900/50 border-green-700 text-green-100 hover:bg-green-800'}`}>{isMuted ? <VolumeX className="w-4 h-4 mx-auto mb-1"/> : <Volume2 className="w-4 h-4 mx-auto mb-1"/>} AUDIO</button>
                    </div>
                </div>
              </header>

              <main className="max-w-7xl mx-auto p-2 md:p-6 flex flex-col gap-8">
                {phase === GAME_PHASES.SETUP_COUNT && (
                  <div className="bg-gray-800 p-8 md:p-12 rounded-[3rem] shadow-2xl text-center max-w-3xl mx-auto mt-10 border-8 border-gray-700 animate-pop-in">
                    <h1 className="text-5xl md:text-7xl font-black text-red-600 mb-2 tracking-tighter uppercase drop-shadow-lg transform -rotate-2">{gameConfig.title}</h1>
                    <h2 className="text-2xl md:text-3xl font-black text-white mb-10 uppercase tracking-widest bg-black/30 inline-block px-6 py-2 rounded-xl transform rotate-1">{gameConfig.subtitle}</h2>
                    <p className="text-lg text-gray-400 font-bold mb-12 tracking-widest uppercase">How many degenerates are playing?</p>
                    <div className="flex flex-wrap justify-center gap-6 mb-12">
                      {[2, 3, 4, 5, 6, 7, 8].map(num => (
                        <button key={num} onClick={() => initNameSetup(num)} className="w-20 h-20 rounded-2xl bg-gray-700 text-white font-black text-4xl shadow-xl hover:scale-110 hover:bg-red-600 hover:shadow-red-900/50 transition-all border-2 border-gray-600">{num}</button>
                      ))}
                    </div>
                    <button onClick={() => setShowRules(true)} className="flex items-center justify-center gap-2 mx-auto text-gray-500 hover:text-white font-bold transition-colors mt-8 uppercase tracking-widest text-sm"><BookOpen className="w-5 h-5" /> Rules of Engagement</button>
                  </div>
                )}

                {showRules && (
                  <div className="fixed inset-0 bg-black/90 backdrop-blur-md z-[80] flex items-center justify-center p-4">
                    <div className="bg-gray-800 rounded-3xl p-6 md:p-8 max-w-4xl w-full shadow-2xl border-4 border-gray-600 relative animate-pop-in max-h-[90vh] overflow-y-auto custom-scrollbar">
                      <button onClick={() => setShowRules(false)} className="absolute top-4 right-4 p-2 bg-gray-700 rounded-full hover:bg-gray-600 z-10"><X className="w-6 h-6 text-gray-300" /></button>
                      
                      <div className="text-center mb-8">
                          <h2 className="text-4xl md:text-5xl font-black text-red-500 mb-2 uppercase tracking-tighter">Rules of Engagement</h2>
                          <p className="text-gray-400 font-bold uppercase tracking-widest text-sm">Read this before you ruin Christmas</p>
                      </div>

                      <div className="space-y-8 text-gray-300">
                        
                        {/* SECTION 1: THE OBJECTIVE */}
                        <div className="bg-black/30 p-6 rounded-2xl border border-gray-700">
                            <h3 className="text-2xl font-black text-white mb-4 flex items-center gap-2">üéØ The Objective</h3>
                            <p className="text-lg">Get to the end of the board. The first person to reach the <span className="text-yellow-400 font-bold">FINISH</span> line triggers the end of the game. Everyone else loses and must drink/do chores/shame themselves.</p>
                        </div>

                        {/* SECTION 2: CHARACTERS */}
                        <div className="bg-black/30 p-6 rounded-2xl border border-gray-700">
                            <h3 className="text-2xl font-black text-white mb-6 flex items-center gap-2">üé≠ Character Roles & Abilities</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="flex gap-3 items-start bg-gray-900/50 p-3 rounded-xl">
                                    <div className="text-3xl">üç∫</div>
                                    <div><span className="font-bold text-white block">The Drunk</span>Starts the game with <span className="text-blue-400 font-bold">"Uncle Mike's Flask"</span> (A Shield card). Use it to block an attack!</div>
                                </div>
                                <div className="flex gap-3 items-start bg-gray-900/50 p-3 rounded-xl">
                                    <div className="text-3xl">üë±‚Äç‚ôÄÔ∏è</div>
                                    <div><span className="font-bold text-white block">The Karen</span><span className="text-amber-400 font-bold">Snitch Bonus:</span> If another player tries to CHEAT and fails, you instantly move forward +3 spaces because you demanded to speak to the manager.</div>
                                </div>
                                <div className="flex gap-3 items-start bg-gray-900/50 p-3 rounded-xl">
                                    <div className="text-3xl">ü•¨</div>
                                    <div><span className="font-bold text-white block">The Stoner</span><span className="text-green-400 font-bold">Too Chill:</span> Immune to "Skip Turn" effects. You're already on the couch, you don't care.</div>
                                </div>
                                <div className="flex gap-3 items-start bg-gray-900/50 p-3 rounded-xl">
                                    <div className="text-3xl">üñï</div>
                                    <div><span className="font-bold text-white block">The Asshole</span><span className="text-red-400 font-bold">Heavy Hitter:</span> When you play a card that pushes someone back, it pushes them back <span className="font-bold text-white">+1 extra space</span>.</div>
                                </div>
                                <div className="flex gap-3 items-start bg-gray-900/50 p-3 rounded-xl">
                                    <div className="text-3xl">üëî</div>
                                    <div><span className="font-bold text-white block">The Dad</span>Starts with <span className="text-red-400 font-bold">"The Belt"</span> (Offensive Card). Pushes a player back 2 spaces.</div>
                                </div>
                                <div className="flex gap-3 items-start bg-gray-900/50 p-3 rounded-xl">
                                    <div className="text-3xl">üç∑</div>
                                    <div><span className="font-bold text-white block">The Mom</span>Starts with <span className="text-blue-400 font-bold">"Guilt Trip"</span> (Movement Card). Moves you forward 3 spaces.</div>
                                </div>
                                <div className="flex gap-3 items-start bg-gray-900/50 p-3 rounded-xl">
                                    <div className="text-3xl">üêï</div>
                                    <div><span className="font-bold text-white block">The Dog</span>Starts with a <span className="text-blue-400 font-bold">Shield</span> active. The first attack against you is blocked automatically because you're a good boy.</div>
                                </div>
                                <div className="flex gap-3 items-start bg-gray-900/50 p-3 rounded-xl">
                                    <div className="text-3xl">‚úùÔ∏è</div>
                                    <div><span className="font-bold text-white block">The Prude</span>Starts with <span className="text-blue-400 font-bold">"Aunt Sheila's Bible"</span> (Shield). You are protected from the first sin committed against you.</div>
                                </div>
                            </div>
                        </div>

                        {/* SECTION 3: MECHANICS */}
                        <div className="bg-black/30 p-6 rounded-2xl border border-gray-700">
                            <h3 className="text-2xl font-black text-white mb-4 flex items-center gap-2">‚öôÔ∏è Game Mechanics</h3>
                            <ul className="space-y-4 list-disc pl-5">
                                <li><strong className="text-white">Cheating:</strong> On your turn, you can press the <span className="text-gray-400 font-mono text-xs border border-gray-600 px-1 rounded">CHEAT</span> button. 
                                    <br/><span className="text-green-400">Success:</span> Move +5 spaces. 
                                    <br/><span className="text-red-400">Fail:</span> Move BACK 5 spaces (and Karens get a bonus).
                                </li>
                                <li><strong className="text-white">Bar Fights:</strong> If you land on the exact same tile as another player, a <span className="text-red-500 font-bold">BATTLE</span> starts. The RNG gods decide the winner. The loser gets knocked back 1 space.</li>
                                <li><strong className="text-white">Rigged / Whine:</strong> If you are in last place, a "WHINE" button appears. You can cry to the family. They might vote to give you pity (+3 spaces) or mock you (no effect).</li>
                                <li><strong className="text-white">Special Tiles:</strong> Some board tiles trigger events (like tripping over Uncle Jim or stepping in Dog Puke). Watch out!</li>
                            </ul>
                        </div>

                        {/* SECTION 4: ADMIN PANEL */}
                        <div className="bg-blue-900/20 p-6 rounded-2xl border border-blue-900/50">
                            <h3 className="text-2xl font-black text-blue-300 mb-4 flex items-center gap-2"><Settings className="w-6 h-6"/> The Admin Panel</h3>
                            <p className="mb-4">Accessible via the <Settings className="w-4 h-4 inline"/> icon in the top header. This is the "God Mode" for the game host.</p>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div className="bg-gray-900/80 p-3 rounded-lg">
                                    <strong className="text-white block mb-1">General Settings</strong>
                                    Change the Game Title, Subtitle, and Logo URL. Toggle the snowy background or the mini-TV if they are annoying you.
                                </div>
                                <div className="bg-gray-900/80 p-3 rounded-lg">
                                    <strong className="text-white block mb-1">Deck Editor</strong>
                                    Click on ANY card in the "Naughty" or "Nice" tabs to edit it.
                                    <ul className="list-disc pl-4 mt-1 text-gray-400">
                                        <li>Rename "Uncle Mike's Flask" to "Dad's Beer"</li>
                                        <li>Change descriptions to match inside jokes</li>
                                        <li>Adjust flavor text for maximum insult</li>
                                    </ul>
                                </div>
                                <div className="bg-gray-900/80 p-3 rounded-lg">
                                    <strong className="text-white block mb-1">Reset Defaults</strong>
                                    If you mess up the cards too much, hit the red "Reset Defaults" button to restore the original game data.
                                </div>
                            </div>
                        </div>

                        <div className="bg-red-900/20 p-4 rounded-xl border border-red-900/50 text-center">
                            <p className="text-red-400 font-bold uppercase text-sm mb-1">Warning</p>
                            <p className="text-red-200 text-sm">This game causes arguments. We are not responsible for ruined holidays.</p>
                        </div>

                      </div>
                      <button onClick={() => setShowRules(false)} className="w-full mt-8 bg-white text-black font-black py-4 rounded-xl text-xl hover:scale-[1.02] transition-transform shadow-xl">I Understand, Let's Fight.</button>
                    </div>
                  </div>
                )}

                {phase === GAME_PHASES.SETUP_NAMES && (
                  <div className="bg-gray-800 p-8 rounded-[2rem] shadow-2xl max-w-3xl mx-auto mt-10 border-4 border-gray-700 animate-fade-in-up">
                    <h2 className="text-4xl font-black mb-10 text-white text-center flex items-center justify-center gap-3"><Edit2 className="w-8 h-8 text-gray-400"/> Player Setup</h2>
                    <div className="space-y-4 mb-10 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
                      {Array.from({ length: playerCount }).map((_, i) => (
                        <div key={i} className="flex flex-col md:flex-row gap-4 items-center bg-gray-900/50 p-4 rounded-2xl border border-gray-700 hover:border-gray-500 transition-colors">
                          <div className={`w-16 h-16 rounded-full flex items-center justify-center text-3xl shadow-lg ${COLORS[i].bg} text-white shrink-0`}>{COLORS[i].icon}</div>
                          <input type="text" maxLength={12} value={playerNames[i]} onChange={(e) => { const n = [...playerNames]; n[i] = e.target.value; setPlayerNames(n); }} placeholder={`Player ${i + 1}`} className="flex-1 border-2 border-gray-600 bg-gray-800 text-white rounded-xl px-4 py-3 font-bold text-lg focus:border-blue-500 outline-none transition-colors" />
                          <div className="relative flex-1 w-full md:w-auto">
                              <select value={playerRoles[i]} onChange={(e) => { const r = [...playerRoles]; r[i] = e.target.value; setPlayerRoles(r); }} className="w-full border-2 border-gray-600 bg-gray-800 text-white rounded-xl px-4 py-3 font-bold appearance-none cursor-pointer hover:bg-gray-700 transition-colors">
                                {Object.values(ROLES).map(role => (<option key={role.id} value={role.id}>{role.name}</option>))}
                              </select>
                              <ArrowRight className="absolute right-4 top-4 w-4 h-4 text-gray-400 rotate-90 pointer-events-none" />
                          </div>
                        </div>
                      ))}
                    </div>
                    <button onClick={finalizeSetup} className="w-full bg-gradient-to-r from-green-600 to-green-800 text-white font-black py-5 rounded-2xl shadow-xl hover:scale-[1.02] transition-transform text-2xl tracking-widest border-t-2 border-green-400">START DRINKING</button>
                  </div>
                )}

                {!['SETUP_COUNT', 'SETUP_NAMES'].includes(phase) && (
                  <div className="flex flex-col gap-8 animate-in fade-in duration-700">
                    
                    {/* 1. JUMBO SCREEN (HUD + LOGS) */}
                    <Jumbotron player={players[currentPlayerIdx]} logs={logs} deckCounts={{ naughty: offensivePile.length, nice: defensivePile.length }} />

                    {/* 2. CONTROL DECK (Actions) */}
                    <div className="max-w-3xl mx-auto w-full flex flex-col gap-4 px-2">
                        <div className="bg-gray-800 p-3 rounded-3xl flex items-center justify-between gap-3 shadow-xl border border-gray-700 relative overflow-hidden">
                            {/* Texture Overlay */}
                            <div className="absolute inset-0 opacity-5 pointer-events-none" style={{backgroundImage: 'repeating-linear-gradient(45deg, #000 0, #000 1px, transparent 0, transparent 50%)', backgroundSize: '10px 10px'}}></div>
                            
                            {phase === GAME_PHASES.START_TURN && (
                                <>
                                    <button onClick={rollDice} className="flex-[2] bg-gradient-to-br from-green-600 to-green-900 text-white font-black py-6 rounded-2xl shadow-lg text-3xl hover:scale-[1.02] active:scale-95 transition-all uppercase tracking-widest border-b-8 border-green-950 relative z-10 group">
                                        <span className="group-hover:animate-pulse">Roll Dice</span>
                                    </button>
                                    <div className="flex flex-col gap-2 flex-1">
                                        <button onClick={handleCheat} className="bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white px-4 py-2 rounded-xl font-bold text-xs flex items-center justify-center gap-2 border-b-4 border-gray-900 active:border-b-0 active:translate-y-1 transition-all h-full">
                                            <Devil className="w-5 h-5" /> CHEAT
                                        </button>
                                        {canUseRigged && (
                                            <button onClick={handleRiggedClick} className="bg-pink-900/80 hover:bg-pink-800 text-pink-200 px-4 py-2 rounded-xl font-bold text-xs border-b-4 border-pink-950 active:border-b-0 active:translate-y-1 transition-all h-full animate-pulse">
                                                WHINE
                                            </button>
                                        )}
                                    </div>
                                </>
                            )}
                            {(phase === GAME_PHASES.ROLLING || phase === GAME_PHASES.MOVING) && (
                                <div className="w-full flex items-center justify-center py-4">
                                    <div className={`text-8xl font-black text-amber-400 drop-shadow-2xl font-mono bg-black/40 px-8 py-2 rounded-2xl border-4 border-amber-600 ${phase === GAME_PHASES.ROLLING ? 'dice-shake' : ''}`}>{diceVal !== null ? diceVal : '?'}</div>
                                </div>
                            )}
                            {phase === GAME_PHASES.DRAW_CHOICE && (
                                <div className="flex-1">
                                    <button onClick={drawMysteryCard} className="w-full bg-gradient-to-r from-purple-800 to-indigo-900 border-b-8 border-indigo-950 text-white py-5 rounded-2xl font-black hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-4 text-2xl shadow-xl animate-pulse">
                                      <Gift className="w-8 h-8" /> DRAW MYSTERY CARD <HelpCircle className="w-6 h-6 opacity-50"/>
                                    </button>
                                </div>
                            )}
                            {![GAME_PHASES.START_TURN, GAME_PHASES.ROLLING, GAME_PHASES.MOVING, GAME_PHASES.DRAW_CHOICE].includes(phase) && (
                                <div className="w-full text-center text-gray-500 font-mono text-sm py-6">Waiting for actions...</div>
                            )}
                        </div>
                    </div>

                    {/* 3. THE FIELD (BOARD) */}
                    <div className="table-cloth p-6 md:p-10 shadow-[0_20px_60px_rgba(0,0,0,0.7)] relative overflow-hidden mx-2 md:mx-0">
                       <div className="beer-ring w-24 h-24 top-10 left-10 opacity-30"></div>
                       <div className="beer-ring w-20 h-20 bottom-20 right-10 opacity-20"></div>
                       
                       {renderPath()}
                       <div className="relative z-10 grid grid-cols-5 gap-3 md:gap-6 max-w-3xl mx-auto">{renderBoard()}</div>
                    </div>

                    {battleState && (
                        <div className="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-gray-900 rounded-3xl p-8 md:p-12 max-w-lg w-full text-center border-8 border-red-700 animate-pop-in shadow-[0_0_100px_rgba(220,38,38,0.5)]">
                                <Swords className="w-24 h-24 text-red-600 mx-auto mb-6 animate-pulse filter drop-shadow-[0_0_20px_rgba(220,38,38,0.8)]" />
                                <h2 className="text-6xl font-black text-white mb-8 uppercase tracking-tighter italic transform -skew-x-12">BAR FIGHT!</h2>
                                {battleState.step === 'FIGHT_INTRO' && (
                                    <>
                                        <div className="flex justify-center items-center gap-6 mb-10 text-gray-200">
                                            <div className="text-2xl font-bold bg-black/50 px-4 py-2 rounded-xl border border-gray-700">{battleState.attacker.name}</div>
                                            <div className="text-5xl text-red-600 font-black">VS</div>
                                            <div className="text-2xl font-bold bg-black/50 px-4 py-2 rounded-xl border border-gray-700">{battleState.defender.name}</div>
                                        </div>
                                        <button onClick={handleFight} className="bg-red-700 text-white px-12 py-6 rounded-2xl font-black text-3xl hover:scale-110 transition-transform shadow-2xl animate-bounce">PUNCH!</button>
                                    </>
                                )}
                                {battleState.step === 'FIGHT_RESULT' && (
                                    <>
                                        <h3 className="text-4xl font-black mb-4 text-green-400 drop-shadow-md">{battleState.winner === battleState.attacker.id ? battleState.attacker.name : battleState.defender.name} WINS!</h3>
                                        <p className="text-2xl text-gray-400 mb-10 font-bold">{players.find(p => p.id === battleState.loser).name} eats dirt!</p>
                                        <button onClick={finalizeBattle} className="bg-gray-700 text-white px-10 py-4 rounded-xl font-bold text-xl hover:bg-gray-600">Whatever.</button>
                                    </>
                                )}
                            </div>
                        </div>
                    )}

                    {targetMode && (
                       <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                         <div className="bg-gray-800 rounded-3xl p-8 max-w-2xl w-full shadow-2xl animate-pop-in border-4 border-amber-600">
                           <h3 className="text-3xl font-black text-center mb-8 text-gray-200">Who gets hit by <span className="text-amber-400 underline decoration-4 decoration-amber-600">"{selectedCard.title}"</span>?</h3>
                           <div className="grid grid-cols-2 md:grid-cols-3 gap-4 max-h-[60vh] overflow-y-auto p-2 custom-scrollbar">
                             {players.map(p => (
                               <button key={p.id} onClick={() => executeCardEffect(p.id)} className={`p-4 rounded-2xl border-4 transition-all ${p.color.border} bg-gray-900 hover:bg-gray-800 hover:scale-105 flex flex-col items-center justify-center gap-3 group`}>
                                 <span className="text-5xl group-hover:scale-110 transition-transform">{p.icon}</span> 
                                 <span className="text-gray-200 font-black uppercase text-sm">{p.name}</span>
                               </button>
                             ))}
                           </div>
                           <button onClick={() => { setTargetMode(false); setSelectedCard(null); }} className="mt-8 w-full py-4 text-gray-400 hover:bg-gray-700 rounded-xl font-bold border-2 border-gray-700 hover:text-white transition-colors">Cancel</button>
                         </div>
                       </div>
                    )}

                    {/* 4. PLAYER HAND (Bench) */}
                    <div className="bg-gray-900/80 backdrop-blur-md p-6 rounded-[2rem] shadow-2xl border border-gray-700 flex flex-col mb-10 mx-2 md:mx-0">
                        <div className="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                          <h3 className="font-black text-gray-400 text-sm uppercase tracking-[0.2em] flex items-center gap-2"><Utensils className="w-4 h-4" /> {players[currentPlayerIdx].name}'s Hand</h3>
                          <span className="bg-gray-800 text-gray-300 px-4 py-1 rounded-full text-xs font-bold shadow-inner border border-gray-600">{players[currentPlayerIdx].cards.length} Cards</span>
                        </div>
                        <div className="flex-1 overflow-x-auto pb-6 custom-scrollbar min-h-[280px] flex items-center">
                          {players[currentPlayerIdx].cards.length === 0 ? (
                             <div className="w-full flex flex-col items-center justify-center text-gray-600 border-4 border-dashed border-gray-700 rounded-3xl h-60 bg-black/20"><Dna className="w-16 h-16 mb-4 opacity-20" /><span className="font-bold text-xl italic opacity-50">Empty Hand</span></div>
                          ) : (
                            <div className="flex gap-4 px-4">
                              {players[currentPlayerIdx].cards.map((card, idx) => (<Card key={idx} card={card} isSelected={selectedCard?.index === idx} onClick={() => { if (phase === GAME_PHASES.START_TURN) playCard(idx); }} />))}
                            </div>
                          )}
                        </div>
                    </div>
                  </div>
                )}
              </main>
            </div>
          );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<PrebegSpanksGiving />);
    </script>
</body>
</html>
